# /grammar-validate

Cross-agent grammar validation for Ukrainian curriculum content.

> **Complete workflow integration:** See **`docs/B1-PLUS-MODULE-WORKFLOW.md`** - Grammar Validation section for:
> - When to use grammar validation (recommended for all B1+ modules)
> - Integration with 4-stage module creation pipeline
> - Automated vs manual validation options
> - How to fix grammar violations

## Usage

```
/grammar-validate <module-path>
/grammar-validate curriculum/l2-uk-en/b1/17-motion-coming-going.md
/grammar-validate b1/17        # Shorthand
/grammar-validate b1 2-5       # Batch mode
```

---

## Batch Mode (Multiple Modules)

**When arguments contain a range (e.g., `b1 2-5`):**

Use the **subagent pattern** to process each module with fresh context:

```
For each module in range:
  1. Spawn Task agent with subagent_type="general-purpose"
  2. Agent prompt: "Run /grammar-validate {level} {module_num} - validate single module"
  3. Wait for agent completion
  4. Log result (validated/pending/failed)
  5. Continue to next module (fresh context)
```

**Why subagents?**
- Each module gets full context capacity
- Grammar validation is context-heavy (rules + items)
- Prevents context exhaustion on large batches

**Example batch execution:**
```
/grammar-validate b1 2-5

→ Task agent: /grammar-validate b1 2 → ✅ Validated (12/12)
→ Task agent: /grammar-validate b1 3 → ✅ Validated (8/8)
→ Task agent: /grammar-validate b1 4 → ⚠️ Validated (6/8, 2 rejected)
→ Task agent: /grammar-validate b1 5 → ✅ Validated (10/10)

Summary: 4/4 validated
```

---

## Single Module Mode

## Purpose

Validate grammar in queue files generated by the audit system using LLM-based semantic validation.

**Workflow position:**
```
/module-create → /grammar-validate → /review-content → /module-stage-4
```

## Instructions

### Step 1: Locate Queue File

Find the grammar queue file for the specified module:
```
curriculum/l2-uk-en/{level}/queue/{module}.yaml
```

If no queue file exists, run the generator:
```bash
.venv/bin/python scripts/generate_grammar_queue.py {module.md}
```
This will create the queue file in the `queue/` subfolder.

**Options:**
- `--sample 25` - Sample 25% of items for faster validation (useful for large modules)

**Supported activity types:**
- `error-correction` - Validates error/corrected sentence pairs
- `fill-in` - Validates complete sentences (answer inserted into blank)
- `cloze` - Validates complete passages (all blanks filled with answers)
- `unjumble` - Validates answer sentences
- `quiz` - Validates questions and options
- `translate` - Validates Ukrainian sentences
- `true-false` - Validates statements

### Step 2: Read Queue

Load the YAML queue file. Each item has this structure:

```yaml
items:
  - activity: error-correction
    title: "Activity title"
    sentence_with_error: "Я прийшов до Львова потягом."
    error: "прийшов"
    answer: "приїхав"
    sentence_corrected: "Я приїхав до Львова потягом."
    validate:
      error_is_real_mistake: null      # You fill this
      corrected_sentence_valid: null   # You fill this
      explanation: null                # You fill this
      confidence: null                 # You fill this
```

### Step 3: Semantic Validation

For each item, apply the Grammar Validator rules below:

#### 3a. Validate the ERROR is a real mistake

Check if `sentence_with_error` contains a genuine error:

**Real errors (flag as `error_is_real_mistake: true`):**
- Russianisms: кушать, ложить, кто, что
- Surzhyk: mixed Ukrainian-Russian grammar
- Case errors: wrong case after verb/preposition
- Agreement errors: gender/case/number mismatch
- Calques: "робити сенс" (make sense)
- Aspect errors: wrong aspect for context
- Spelling: non-existent words

**NOT real errors (flag as `error_is_real_mistake: false`):**
- Pedagogical simplifications appropriate for the level
- Style/register differences (both forms acceptable)
- Regional variations (both standard Ukrainian)

#### 3b. Validate the CORRECTED sentence is valid

Check if `sentence_corrected` is grammatically correct:

**Valid (`corrected_sentence_valid: true`):**
- Grammatically correct Ukrainian
- Natural word order
- Appropriate for the level
- No Russianisms/calques

**Invalid (`corrected_sentence_valid: false`):**
- Contains grammar errors
- Unnatural/awkward phrasing
- Contains Russianisms or calques
- Wrong case/aspect/agreement

### Step 4: Finalize using Python Script

**Do NOT write the audit file manually.** Instead, use the provided Python script which handles:
1.  Generating the audit file with correct metadata
2.  Preserving your validation notes and fixes
3.  Auto-updating the Review Report status
4.  Cleaning up the queue file

**Command:**
```bash
.venv/bin/python scripts/finalize_validation.py {queue_file_path} "{notes}"
```

**Example:**
```bash
.venv/bin/python scripts/finalize_validation.py curriculum/l2-uk-en/b1/queue/01-how-to-talk-about-grammar.yaml "Fixed 1 Russianism"
```

### Step 5: Apply Fixes (When Validation Finds Problems)

**CRITICAL: Do NOT improvise fixes. Follow these exact rules.**

#### 5a. When `error_is_real_mistake: false` (fake error)

The "error" isn't actually wrong - both forms are acceptable.

**Action:** DELETE the item from the activities file. Do not try to "fix" it.

```yaml
# BEFORE (in activities file):
- sentence: Він прийшов до мене.
  error: прийшов
  answer: прибув
  # Validation: error_is_real_mistake: false (both are correct)

# AFTER: Delete this entire item
```

#### 5b. When `corrected_sentence_valid: false` (bad correction)

The correction itself has grammar problems.

**Action:** Fix the `answer` and recalculate `sentence_corrected`.

```yaml
# BEFORE:
- sentence: Я дав книгу мій друг.
  error: мій друг
  answer: мого друга  # WRONG - should be dative

# AFTER:
- sentence: Я дав книгу мій друг.
  error: мій друг
  answer: моєму другу  # CORRECT - dative case
```

**Rules for fixing corrections:**
- Check case government (verb → required case)
- Do NOT change the sentence structure
- Do NOT add words or change meaning

#### 5c. Summary of Actions

| Problem | Action |
|---------|--------|
| `error_is_real_mistake: false` | DELETE the item |
| `corrected_sentence_valid: false` | FIX the answer only |
| `confidence < 0.7` | FLAG for human review, do not fix |

**DO NOT:**
- Invent new sentences
- Change sentence meaning or structure
- Add words that weren't there
- "Improve" sentences that passed validation
- Fix items flagged for human review

### Step 6: Log Fixes (Pre-Finalization)

**If you made fixes (deleted items or fixed corrections):**

You MUST log this **in the queue YAML file** *before* running the finalization script. The script will read this and preserve it in the audit trail.

**How to log a fix:**
1.  Modify the item in the queue YAML (fix the `answer` or `sentence`).
2.  Add the `validate` block to that item:

```yaml
    validate:
      action: "fixed"
      notes: "Fixed Russianism: 'рахувати' -> 'вважати'"
      confidence: 1.0
```

**If you Deleted an item:**
Just delete it from the YAML file. The script will record a lower total item count, and you should mention "Deleted X items" in the script notes argument.

### Step 7: Clean Up

The script `finalize_validation.py` automatically deletes the queue file. You do not need to delete it manually.

---

## Grammar Validator Rules (Embedded)

### Core Principles

1. **No Russianisms/Surzhyk** - Always flag:
   - кушать → їсти
   - ложить → класти
   - кто/что → хто/що
   - Mixed grammar patterns

2. **No Calques** - Flag English loan translations:
   - "робити сенс" → "мати сенс"
   - "приймати рішення" is OK (established)
   - "брати участь" is OK (established)

3. **Case Government** - Verify correct cases:
   - дати + dative (кому?)
   - бачити + accusative (кого? що?)
   - допомагати + dative (кому?)
   - After prepositions: check required case

4. **Aspect Correctness** - Check context:
   - Single completed action → perfective
   - Repeated/ongoing → imperfective
   - Negation often → imperfective
   - Future intentions → usually perfective

5. **Motion Verb Prefixes** - For B1 motion modules:
   - при- = arrival (приїхати, прийти)
   - ви- = departure (виїхати, вийти)
   - пере- = crossing (перейти, переїхати)
   - про- = passing through (пройти, проїхати)
   - за- = stopping by (зайти, заїхати)
   - об- = going around (обійти, об'їхати)

### Level-Aware Validation

**A1-A2 (Allow pedagogical simplifications):**
- Explicit copula "є" in "Це є книга" - OK for teaching
- Analytic future "буду + infinitive" - OK for teaching
- Simple word order - OK for beginners

**B1-B2 (Expect natural grammar):**
- Full aspect system
- Correct motion verb prefixes
- Natural word order
- Correct case government

**C1-C2 (Demand native-like accuracy):**
- Stylistic nuances
- Register appropriateness
- Idiomatic expressions

### Error Type Taxonomy

When flagging errors, categorize:
- `russianism` - Russian borrowing
- `surzhyk` - Mixed Ukrainian-Russian
- `calque` - English loan translation
- `case_error` - Wrong case
- `aspect_error` - Wrong aspect
- `agreement` - Gender/number mismatch
- `prefix_error` - Wrong motion verb prefix
- `spelling` - Non-existent word
- `word_order` - Ungrammatical order

### Confidence Levels

- **1.0** - Absolutely certain (clear Russianism, obvious case error)
- **0.9** - Very confident (standard grammar rules)
- **0.8** - Confident (context-dependent but clear)
- **0.7** - Somewhat confident (could be style choice)
- **< 0.7** - Flag for human review

---

## Output Format

Save validated results to `audit/{module-slug}-grammar.yaml`:

```yaml
module: 17-motion-coming-going
level: B1
validated: 2025-12-27T15:30:00
validator: claude-cross-agent
summary:
  total_items: 6
  errors_confirmed: 5
  errors_rejected: 1
  needs_review: 0

items:
  - activity: error-correction
    title: "Помилки з префіксами"
    sentence_with_error: "Я прийшов до Львова потягом."
    error: "прийшов"
    answer: "приїхав"
    sentence_corrected: "Я приїхав до Львова потягом."
    validate:
      error_is_real_mistake: true
      corrected_sentence_valid: true
      explanation: "«Прийшов» (пішки) неправильно для подорожі потягом. «Приїхав» вживається для прибуття транспортом."
      confidence: 0.95
      error_type: prefix_error
```

**File location:** `curriculum/l2-uk-en/b1/audit/17-motion-coming-going-grammar.yaml`

---

## Example Validation Session

**Input (from queue):**
```yaml
- sentence_with_error: "Я кушаю яблуко."
  error: "кушаю"
  answer: "їм"
  sentence_corrected: "Я їм яблуко."
```

**Validation thinking:**
1. "кушаю" - Is this a real error?
   - Yes! "кушать" is a Russianism, not Ukrainian
   - Ukrainian: "їсти" (to eat)
   - `error_is_real_mistake: true`

2. "Я їм яблуко" - Is this valid?
   - Yes, grammatically correct
   - Natural Ukrainian
   - `corrected_sentence_valid: true`

**Output:**
```yaml
validate:
  error_is_real_mistake: true
  corrected_sentence_valid: true
  explanation: "«Кушати» — русизм. Правильно: «їсти» (НДВ) або «з'їсти» (ДВ)."
  confidence: 1.0
  error_type: russianism
```

---

## Checklist

Before completing validation:

- [ ] All items in queue have been validated
- [ ] Each item has all `validate` fields filled
- [ ] Explanations are in Ukrainian
- [ ] Confidence scores assigned
- [ ] Error types categorized
- [ ] Summary statistics calculated
- [ ] Output saved to `audit/{module}-grammar.yaml`
- [ ] Queue file deleted from `queue/` folder
- [ ] MDX regenerated: `npm run generate l2-uk-en {level} {module}`

---

## Required Reporting (CRITICAL)

**You MUST provide explicit reporting of all changes.** Do not just summarize - show exactly what you did.

### Report Format

After completing validation, output a report like this:

```markdown
## Grammar Validation Report: M09

### Summary
- **Items validated:** 8
- **Passed:** 7
- **Deleted:** 1
- **Fixed:** 0

### Deleted Items (show full content)

**Item 2** - DELETED (hallucinated word)
- Sentence: "Я працюватиму над проєктом і завершиму його нарешті до кінця тижня."
- Flagged error: працюватиму
- Reason: "завершиму" is not a valid Ukrainian word (hallucination)
- Action: Removed from `activities/09-aspect-integration.yaml` lines 298-302

### Fixed Items (show before/after)

**Item 5** - FIXED (wrong correction)
- Before: `answer: мого друга`
- After: `answer: моєму другу`
- Reason: Dative case required after "дав"
- File: `activities/09-aspect-integration.yaml` line 156

### Files Modified
1. `curriculum/l2-uk-en/b1/activities/09-aspect-integration.yaml` - deleted 1 item
2. `curriculum/l2-uk-en/b1/audit/09-aspect-integration-grammar.yaml` - created

### Regeneration
✅ Ran: `npm run generate l2-uk-en b1 9`
```

### Why This Matters

- The user cannot review changes without seeing the actual content
- "Deleted 1 item" is not actionable - show WHAT was deleted
- "Fixed 2 errors" is not verifiable - show the before/after
- This creates an audit trail for quality control

### DO NOT

- Say "deleted 1 item" without showing the content
- Say "fixed grammar errors" without showing what changed
- Complete validation without regenerating MDX
- Assume the user can find the changes themselves
