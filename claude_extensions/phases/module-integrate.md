# Phase 7: module-integrate

Deploy module with skeleton vocabulary. Full vocab enrichment runs separately.

## Usage

```
/module-integrate {level} {module_num}
```

## Input (LOCKED from previous phases)

- `curriculum/l2-uk-en/{level}/meta/{slug}.yaml` (Phase 2)
- `curriculum/l2-uk-en/{level}/{slug}.md` (Phase 4)
- `curriculum/l2-uk-en/{level}/activities/{slug}.yaml` (Phase 6)

## Output

- `curriculum/l2-uk-en/{level}/vocabulary/{slug}.yaml` (skeleton)
- `docusaurus/docs/{level}/module-{num}.mdx` (deployment)

> **IMPORTANT:** Do NOT create or modify `review/*-review.md` files.
> These are auto-generated by the audit script. Never overwrite them.

---

## Integration Process

### Step 1: Verify Locked Files Present

Check that content files exist:

```bash
files=(
  "curriculum/l2-uk-en/{level}/meta/{slug}.yaml"
  "curriculum/l2-uk-en/{level}/{slug}.md"
  "curriculum/l2-uk-en/{level}/activities/{slug}.yaml"
)

for file in "${files[@]}"; do
  if [[ ! -f "$file" ]]; then
    FAIL: Missing locked file: $file
  fi
done
```

### Step 2: Create Skeleton Vocabulary

**Create empty vocabulary file if it doesn't exist:**

```yaml
# curriculum/l2-uk-en/{level}/vocabulary/{slug}.yaml
module: { slug }
level: { LEVEL }
version: '2.0'
items: [] # Empty - will be enriched by /module-vocab-enrich
```

**If file already exists:** Use existing (may be partially enriched).

### Step 3: Cross-File Consistency Checks

#### 3.1 Metadata Consistency

```python
# Check all files have matching module identifiers
meta = yaml.safe_load(open(f'meta/{slug}.yaml'))

# Extract frontmatter from lesson
with open(f'{slug}.md') as f:
    frontmatter = parse_frontmatter(f.read())

if meta['id'] != frontmatter['module']:
    FAIL: Module ID mismatch between meta and lesson
```

#### 3.2 Word Count Verification

```python
word_target = meta['word_target']
actual_words = count_ukrainian_words(lesson_text)
deviation = abs(actual_words - word_target) / word_target

if deviation > 0.05:
    FAIL: Word count {actual_words} deviates >5% from target {word_target}
```

#### 3.3 Activity Count Verification

```python
minimums = get_minimums(meta['level'])
activity_counts = count_activities_by_type(activities)

if activity_counts['total_activities'] < minimums['total_activities']:
    FAIL: Total activities below minimum
```

### Step 4: Generate MDX

Run the official generator script to build the MDX file. This script handles:

- Correct filename generation (slug vs module-N)
- Activity component rendering
- Callout conversion
- Vocabulary table injection

```bash
python scripts/generate_mdx.py l2-uk-en {level} {num}
```

**Verify output:**

- For Core (A1-C2): `docusaurus/docs/{level}/module-{num}.mdx`
- For Tracks (b2-hist, etc): `docusaurus/docs/{level}/{slug}.mdx`

### Step 5: Run Final Audit

Run the audit script to verify everything passes:

```bash
.venv/bin/python scripts/audit_module.py curriculum/l2-uk-en/{level}/{slug}.md
```

**The audit script generates `review/{slug}-review.md` automatically.**

> **FORBIDDEN:** Do NOT manually create or edit audit review files.
> The audit script is the ONLY source of truth for review files.
> If you overwrite these files with fake reports, you are hiding real problems.

**If audit fails:** Fix the violations and re-run. Do NOT proceed until all gates pass.

---

## Output

### On SUCCESS

```
INTEGRATION COMPLETE: {level}/{slug}

✓ Meta verified
✓ Lesson verified ({word_count} words)
✓ Activities verified ({activity_count} activities)
✓ Skeleton vocabulary created
✓ MDX generated: docusaurus/docs/{level}/{mdx_filename}
✓ Audit: ALL GATES ✅

Preview: http://localhost:3000/docs/{level}/{slug_or_module_num}

Note: Vocabulary table is empty.
      Run /module-vocab-enrich {level} when track is complete.
```

### On FAILURE

```
INTEGRATION FAILED: {level}/{slug}

Violations:
1. [CHECK_NAME]: {specific issue}

Fix and re-run: /module-integrate {level} {module_num}
```

---

## Deployment Checklist

After integration:

- [ ] MDX file generated
- [ ] Start dev server: `cd docusaurus && pnpm start`
- [ ] Preview module at localhost:3000
- [ ] Test all interactive activities
- [ ] Vocabulary table shows "No items" (expected with skeleton)

## Examples

### Example 1: B2-HIST Integration Success

**Input:** Locked meta, lesson, activities for trypillian-civilization

**Output:**

```
INTEGRATION COMPLETE: b2-hist/trypillian-civilization

✓ Meta verified
✓ Lesson verified (4000 words)
✓ Activities verified (4 activities)
✓ Skeleton vocabulary created
✓ MDX generated: docusaurus/docs/b2-hist/trypillian-civilization.mdx
✓ Audit: ALL GATES ✅

Preview: http://localhost:3000/docs/b2-hist/trypillian-civilization

Note: Vocabulary table is empty.
      Run /module-vocab-enrich b2-hist when track is complete.
```

### Example 2: Core Module Integration

**Input:** A1 module 1 locked files

**Output:**

```
INTEGRATION COMPLETE: a1/01-the-cyrillic-code-i

✓ Meta verified
✓ Lesson verified (958 words)
✓ Activities verified (8 activities)
✓ Skeleton vocabulary created
✓ MDX generated: docusaurus/docs/a1/module-01.mdx
✓ Audit: ALL GATES ✅

Preview: http://localhost:3000/docs/a1/module-01

Note: Vocabulary table is empty.
      Run /module-vocab-enrich a1 when level is complete.
```

---

When track complete:

- [ ] Run /module-vocab-enrich {level}
- [ ] Verify vocabulary tables populated
- [ ] Run `npm run docs:build`
- [ ] Deploy to production
