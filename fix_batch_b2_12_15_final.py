import yaml
import re
import os

# Unjumble Replacements
unjumble_replacements = {
    # M12
    "Можливо, він прийде завтра.": "Цілком можливо, що він прийде до нас у гості вже завтра вранці.",
    "На жаль, ми пропустили зустріч.": "На великий жаль, ми через затори пропустили цю важливу ділову зустріч.",
    "Безумовно, це правильне рішення.": "Безумовно, це було єдине правильне та виважене рішення в цій ситуації.",
    "До речі, я бачив вас учора.": "До речі, я випадково бачив вас учора ввечері біля театру.",
    "По-перше, потрібно проаналізувати дані.": "По-перше, нам потрібно дуже уважно проаналізувати всі отримані статистичні дані.",
    "Отже, ми можемо підсумувати результати.": "Отже, тепер ми нарешті можемо підсумувати остаточні результати нашої роботи.",
    "Мабуть, він уже пішов.": "Мабуть, він уже давно пішов додому, бо світло в кабінеті не горить.",
    "На щастя, ніхто не постраждав.": "На велике щастя, під час цієї аварії ніхто з пасажирів не постраждав.",
    "Як відомо, українська мова є слов'янською.": "Як усім добре відомо, українська мова є однією з наймелодійніших слов'янських мов.",
    "Нарешті, я хочу подякувати всім.": "Нарешті, я хочу щиро подякувати всім присутнім за вашу підтримку.",
    "Іншими словами, проєкт закрито.": "Іншими словами, цей амбітний проєкт, на жаль, було офіційно закрито.",
    "Здається, він помилився з адресою.": "Здається, він трохи помилився з адресою і прийшов не в той будинок.",
    "На думку вчених, клімат змінюється.": "На думку провідних вчених, клімат на планеті стрімко і незворотно змінюється.",
    "На диво, всі погодились.": "На велике диво, всі учасники зборів одразу погодились з моєю пропозицією.",
    "Звичайно, ви маєте рацію.": "Звичайно, ви абсолютно маєте рацію в цьому непростому питанні.",
    "У будь-якому разі, ми продовжуємо працювати.": "У будь-якому разі, незважаючи на труднощі, ми продовжуємо наполегливо працювати.",

    # M13
    "Цю книгу я вже прочитав.": "Цю чудову історичну книгу я вже повністю прочитав минулого літа.",
    "Настала рання весна.": "Нарешті після довгої зими настала довгоочікувана тепла рання весна.",
    "Учора ввечері ми зустрілися.": "Тільки учора пізно ввечері ми нарешті зустрілися після довгої розлуки.",
    "Голосно він це сказав.": "Дуже голосно і впевнено він це сказав перед усіма присутніми.",
    "Небаченим був успіх.": "Справді небаченим і грандіозним був успіх нашої національної збірної.",
    "Саме цей момент став вирішальним.": "Саме цей напружений момент став вирішальним у всій цій грі.",
    "Цей фільм бачили усі.": "Цей відомий класичний фільм, мабуть, бачили вже абсолютно усі.",
    "Тричі вона перечитувала роман.": "Вже тричі вона уважно перечитувала цей захопливий роман про кохання.",
    "Першою прийшла вона.": "На нашу ранкову зустріч першою прийшла саме вона, а не він.",
    "Важливою стала ця подія.": "Надзвичайно важливою стала ця подія для історії нашого міста.",
    "Ніколи раніше він не бачив такого.": "Ніколи раніше він не бачив такого дивовижного природного явища.",
    "Увечері пішов дощ.": "Пізно увечері раптово пішов сильний проливний дощ з грозою.",
    "Чудовою була його робота.": "Справді чудовою і професійною була його робота над цим проєктом.",
    "У цьому місті народився Шевченко.": "Саме у цьому славному місті народився великий український поет Шевченко.",
    "Саме це питання важливе.": "Саме це складне питання зараз є найбільш важливим для нас.",
    "Успішно студенти здали іспит.": "Дуже успішно всі студенти нашої групи здали цей складний іспит.",

    # M14
    "Він не тільки читав, а й писав.": "Він не тільки багато читав книги, а й сам писав цікаві оповідання.",
    "Вона як співає, так і танцює.": "Вона як чудово співає на сцені, так і професійно танцює.",
    "Або ми встигнемо, або запізнимося.": "Або ми зараз встигнемо на автобус, або безнадійно запізнимося на зустріч.",
    "Чи то дощ, чи то сніг.": "На вулиці йде чи то холодний дощ, чи то мокрий сніг.",
    "То сонце світить, то хмари.": "То яскраве сонце світить, то темні хмари закривають усе небо.",
    "Не так важко, як здається.": "Це завдання не так важко виконати, як це може здатися на перший погляд.",
    "Чим більше читаєш, тим більше знаєш.": "Чим більше ти читаєш корисних книг, тим більше ти знаєш про світ.",
    "Якби я знав, я б прийшов.": "Якби я заздалегідь знав про це, я б обов'язково прийшов.",
    "Хоч він і втомився, але працював.": "Хоч він і дуже втомився за день, але продовжував працювати.",
    "Незважаючи на дощ, ми пішли.": "Незважаючи на сильний проливний дощ, ми все одно пішли на прогулянку.",
    "Для того щоб виграти, треба тренуватися.": "Для того щоб виграти у змаганнях, треба багато і наполегливо тренуватися.",
    "Тому що він захворів, він не прийшов.": "Тому що він раптово захворів на грип, він не прийшов сьогодні.",
    "Через те що було пізно, ми пішли.": "Через те що було вже дуже пізно, ми вирішили піти додому.",
    "Унаслідок того що сталась аварія, дорога закрита.": "Унаслідок того що на мосту сталась аварія, дорога повністю закрита.",
    "Завдяки тому що ми вчилися, ми склали іспит.": "Завдяки тому що ми старанно вчилися, ми успішно склали іспит.",
    "У той час як одні працювали, інші відпочивали.": "У той час як одні старанно працювали, інші просто відпочивали в тіні.",

    # M15
    "Це офіційний документ.": "Цей папір — це важливий офіційний документ з печаткою.",
    "Ми проводимо експеримент.": "Ми сьогодні проводимо складний науковий експеримент у лабораторії.",
    "Сонце сідало за гори.": "Червоне сонце повільно сідало за високі сині гори.",
    "Привіт, як справи?": "Привіт, друже, як твої справи сьогодні?",
    "Згідно з законом, це заборонено.": "Згідно з чинним законом України, це суворо заборонено.",
    "Методологія дослідження базується на аналізі.": "Методологія нашого дослідження базується на детальному аналізі даних.",
    "Вітер вив, як голодний звір.": "Холодний вітер вив за вікном, як страшний голодний звір.",
    "Слухай, давай підемо в кіно.": "Слухай, а давай ми сьогодні ввечері підемо разом в кіно.",
    "Наказ набуває чинності з моменту підписання.": "Цей наказ набуває законної чинності з моменту його підписання директором.",
    "Результати підтверджують гіпотезу.": "Отримані нами результати повністю підтверджують висунуту наукову гіпотезу.",
    "Очі її сяяли, як зорі.": "Очі її радісно сяяли в темряві, як яскраві вечірні зорі.",
    "Та ну його, цей ремонт.": "Та ну його, цей нескінченний ремонт, я вже так втомився.",
    "Шановний пане Директоре.": "Шановний пане Директоре, дозвольте звернутися до Вас із проханням.",
    "Атом складається з ядра та електронів.": "Атом будь-якого елемента складається з позитивного ядра та електронів.",
    "Ліс шумів, наче розмовляв.": "Старий ліс таємниче шумів, наче тихо розмовляв із подорожнім.",
    "Ти бачив, що вони утнули?": "Ти бачив, що вони вчора ввечері там утнули?"
}

# Quiz Replacements (Specific failures)
quiz_replacements = {
    # M12
    "Який зі сталих виразів або словосполучень використовується для посилання на статистику?": "Який зі сталих виразів або словосполучень зазвичай використовується для посилання на офіційну статистику?",
    "Який зі сталих виразів або словосполучень вказує на загальновідомий факт?": "Який зі сталих виразів або словосполучень вказує на загальновідомий, незаперечний факт?",
    "Яке з поданих слів або словосполучень виражає суб'єктивне враження мовця?": "Яке з поданих слів або словосполучень найкраще виражає суб'єктивне враження мовця?",
    "Який зі сталих виразів або словосполучень використовується для додаткової інформації?": "Який зі сталих виразів або словосполучень використовується для введення додаткової інформації?",
    "Яке з поданих слів або словосполучень є офіційним синонімом до «мабуть»?": "Яке з поданих слів або словосполучень є стилістично офіційним синонімом до слова «мабуть»?",
    "Який вставний вираз зазвичай використовується для того, щоб логічно завершити перелік аргументів?": "Який вставний вираз зазвичай використовується для того, щоб логічно завершити перелік аргументів?",
    "Яке з наведених вставних слів найкраще вказує на логічний порядок?": "Яке з наведених вставних слів найкраще вказує на логічний порядок викладу думок?",
    
    # M13
    "Яка основна функція інверсії в українській мові?": "Яка основна стилістична функція інверсії (зміни порядку слів) в українській мові?",
    "У якому регістрі інверсія найменш доречна?": "У якому функціональному стилі мовлення використання інверсії є найменш доречним?",
    "Що відбувається з відмінка при зміні порядку слів?": "Що відбувається з граматичними відмінками слів при зміні їхнього порядку в реченні?",
    "Що підкреслюється при фронтуванні додатка?": "Що саме логічно підкреслюється при фронтуванні додатка (винесенні його на початок речення)?",
    "Який базовий порядок слів в українській мові вважається нейтральним?": "Який базовий порядок слів у реченні в українській мові вважається стилістично нейтральним?",
    "Для чого використовується фронтування обставини?": "Для якої комунікативної мети зазвичай використовується фронтування обставини в реченні?",
    "Що характерно для емфатичного порядку слів?": "Що є найбільш характерною рисою емфатичного порядку слів у реченні?",
    "Яка функція речення «Пролунав постріл»?": "Яку стилістичну функцію виконує інверсія присудка в реченні «Пролунав постріл»?",
    
    # M14
    "Які речення містять послідовне підпорядкування?": "У якому з наведених складних речень наявне послідовне підпорядкування підрядних частин?",
    "Які сполучники є протиставними?": "Які з наведених сполучників належать до групи сурядних протиставних сполучників?",
    "Які речення не потребують коми перед «і»?": "У якому з наведених складносурядних речень не потрібно ставити кому перед сполучником «і»?",
    "Які типи підрядних відповідають на питання «чому?»": "Які типи підрядних речень відповідають на питання «чому?» або вказують на причину дії?",
    "Які речення є безсполучниковими?": "Яке з наведених складних речень є безсполучниковим (частини поєднані лише інтонацією)?",
    
    # M15
    "Яке речення є стилістично невідповідним для офіційного документа?": "Яке з поданих речень є стилістично невідповідним та некоректним для використання в офіційному документі?",
    "Яка форма пасиву підкреслює процес, а не результат?": "Яка саме форма пасивного стану головним чином підкреслює тривалий процес дії?",
    "У повсякденній розмові природно сказати...": "У звичайній повсякденній розмові з друзями найбільш природно та невимушено буде сказати...",
    "Яка форма найкраще передає невідомість агента дії?": "Яка пасивна форма найкраще та найприродніше передає повну невідомість агента дії?"
}

def process_file(filepath):
    print(f"Processing {filepath}...")
    with open(filepath, 'r') as f:
        activities = yaml.safe_load(f)
    
    modified = False
    for act in activities:
        # Update Unjumble
        if act.get('type') == 'unjumble':
            for item in act.get('items', []):
                ans = item.get('answer')
                # Try exact match or match stripping punctuation
                key = ans
                if key not in unjumble_replacements and key.strip(".,!?;\"") in unjumble_replacements:
                    key = key.strip(".,!?;\"")
                
                if key in unjumble_replacements:
                    new_ans = unjumble_replacements[key]
                    item['answer'] = new_ans
                    item['words'] = [w.strip(".,!?;\"") for w in new_ans.split() if w.strip(".,!?;\"")]
                    modified = True

        # Update Quiz
        if act.get('type') in ['quiz', 'select']:
            for item in act.get('items', []):
                q = item.get('question')
                # Try exact match first
                if q in quiz_replacements:
                    item['question'] = quiz_replacements[q]
                    modified = True
                else:
                    # Generic expansion if very short (<8 words)
                    if len(q.split()) < 8 and "?" in q:
                        # Add "Визначте," or "Скажіть,"
                        if not q.startswith("Визначте") and not q.startswith("Укажіть"):
                            new_q = "Визначте, " + q[0].lower() + q[1:]
                            if len(new_q.split()) >= 10:
                                item['question'] = new_q
                                modified = True

    if modified:
        with open(filepath, 'w') as f:
            yaml.dump(activities, f, allow_unicode=True, sort_keys=False)
        print("  Updated activities.")

# Process Markdown
def fix_markdown(filepath):
    print(f"Checking markdown {filepath}...")
    with open(filepath, 'r') as f:
        content = f.read()
    
    modified = False
    if "## Тест: Прочитайте текст" in content:
        content = content.replace("## Тест: Прочитайте текст", "## Вступ")
        modified = True
    elif "## Вступ" not in content:
        # Insert before first H2
        parts = content.split("\n## ", 1)
        if len(parts) > 1:
            content = parts[0] + "\n\n## Вступ\n\n" + "## " + parts[1]
            modified = True
            
    if modified:
        with open(filepath, 'w') as f:
            f.write(content)
        print("  Updated markdown.")

# Iterate 12-15
import glob
for i in range(12, 16):
    yaml_files = glob.glob(f"curriculum/l2-uk-en/b2/activities/{i}-*.yaml")
    for f in yaml_files:
        process_file(f)
    
    md_files = glob.glob(f"curriculum/l2-uk-en/b2/{i}-*.md")
    for f in md_files:
        fix_markdown(f)
