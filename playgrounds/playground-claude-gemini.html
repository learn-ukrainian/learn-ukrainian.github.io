<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Claude-Gemini Communication - Live</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: #0f172a;
      color: #e2e8f0;
      min-height: 100vh;
    }

    .container {
      display: grid;
      grid-template-columns: 260px 1fr 320px;
      height: 100vh;
    }

    .back-link {
      position: absolute;
      top: 12px;
      left: 12px;
      color: #3b82f6;
      text-decoration: none;
      font-size: 12px;
      z-index: 100;
    }

    .back-link:hover { text-decoration: underline; }

    .sidebar {
      background: #1e293b;
      padding: 20px;
      padding-top: 40px;
      overflow-y: auto;
      border-right: 1px solid #334155;
    }

    .sidebar h2 {
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #94a3b8;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .sidebar h3 {
      font-size: 12px;
      color: #64748b;
      margin: 20px 0 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .api-badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
    }

    .api-badge.connected { background: #166534; color: #bbf7d0; }
    .api-badge.disconnected { background: #991b1b; color: #fecaca; }

    .task-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .task-item {
      padding: 10px 12px;
      background: #334155;
      border: 1px solid #475569;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .task-item:hover { background: #475569; }
    .task-item.active { background: #3b82f6; border-color: #60a5fa; }

    .task-id {
      font-size: 11px;
      color: #94a3b8;
      font-family: ui-monospace, monospace;
    }

    .task-item.active .task-id { color: #bfdbfe; }

    .task-name {
      font-size: 13px;
      font-weight: 500;
      margin-top: 2px;
    }

    .task-meta {
      font-size: 11px;
      color: #64748b;
      margin-top: 4px;
    }

    .task-item.active .task-meta { color: #93c5fd; }

    .new-task-btn {
      width: 100%;
      padding: 10px;
      background: transparent;
      border: 2px dashed #334155;
      border-radius: 8px;
      color: #64748b;
      cursor: pointer;
      margin-top: 12px;
      transition: all 0.15s;
    }

    .new-task-btn:hover {
      border-color: #3b82f6;
      color: #3b82f6;
    }

    .refresh-btn {
      width: 100%;
      padding: 8px;
      margin-top: 8px;
      background: #334155;
      border: none;
      border-radius: 6px;
      color: #e2e8f0;
      cursor: pointer;
      font-size: 12px;
    }

    .refresh-btn:hover { background: #475569; }

    .main-area {
      display: flex;
      flex-direction: column;
      background: #0f172a;
    }

    .flow-diagram {
      flex: 1;
      padding: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .agent-box {
      width: 180px;
      padding: 20px;
      background: #1e293b;
      border: 2px solid #334155;
      border-radius: 16px;
      text-align: center;
    }

    .agent-box.claude {
      border-color: #f97316;
      background: linear-gradient(135deg, #1e293b 0%, #431407 100%);
    }

    .agent-box.gemini {
      border-color: #3b82f6;
      background: linear-gradient(135deg, #1e293b 0%, #1e3a5f 100%);
    }

    .agent-icon {
      font-size: 36px;
      margin-bottom: 8px;
    }

    .agent-name {
      font-size: 18px;
      font-weight: 600;
    }

    .agent-status {
      font-size: 11px;
      color: #64748b;
      margin-top: 4px;
      font-family: ui-monospace, monospace;
    }

    .agent-models {
      font-size: 10px;
      color: #475569;
      margin-top: 2px;
    }

    .flow-arrow {
      width: 200px;
      height: 80px;
      position: relative;
      margin: 0 20px;
    }

    .arrow-line {
      position: absolute;
      height: 3px;
      background: #475569;
      border-radius: 2px;
    }

    .arrow-line.top {
      top: 20px;
      left: 0;
      right: 0;
    }

    .arrow-line.bottom {
      bottom: 20px;
      left: 0;
      right: 0;
    }

    .arrow-head {
      position: absolute;
      width: 0;
      height: 0;
      border-style: solid;
    }

    .arrow-head.right {
      right: 0;
      top: 14px;
      border-width: 9px 0 9px 12px;
      border-color: transparent transparent transparent #475569;
    }

    .arrow-head.left {
      left: 0;
      bottom: 14px;
      border-width: 9px 12px 9px 0;
      border-color: transparent #475569 transparent transparent;
    }

    .arrow-label {
      position: absolute;
      font-size: 10px;
      color: #64748b;
      white-space: nowrap;
    }

    .arrow-label.top { top: 0; left: 50%; transform: translateX(-50%); }
    .arrow-label.bottom { bottom: 0; left: 50%; transform: translateX(-50%); }

    .broker-box {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      padding: 10px 20px;
      background: #334155;
      border-radius: 8px;
      text-align: center;
    }

    .broker-name {
      font-size: 13px;
      font-weight: 500;
    }

    .broker-path {
      font-size: 10px;
      color: #64748b;
      font-family: ui-monospace, monospace;
    }

    .prompt-area {
      padding: 16px;
      background: #1e293b;
      border-top: 1px solid #334155;
    }

    .prompt-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .prompt-header h4 {
      font-size: 12px;
      color: #94a3b8;
      text-transform: uppercase;
    }

    .copy-btn {
      padding: 4px 12px;
      font-size: 11px;
      background: #3b82f6;
      border: none;
      color: white;
      border-radius: 4px;
      cursor: pointer;
    }

    .copy-btn:hover { background: #2563eb; }
    .copy-btn.copied { background: #10b981; }

    .prompt-code {
      font-family: ui-monospace, monospace;
      font-size: 12px;
      line-height: 1.5;
      color: #94a3b8;
      background: #0f172a;
      padding: 12px;
      border-radius: 6px;
      white-space: pre-wrap;
      max-height: 200px;
      overflow-y: auto;
    }

    .prompt-code .fn { color: #60a5fa; }
    .prompt-code .key { color: #f97316; }
    .prompt-code .str { color: #10b981; }

    .conversation-panel {
      background: #1e293b;
      border-left: 1px solid #334155;
      display: flex;
      flex-direction: column;
    }

    .conv-header {
      padding: 16px;
      border-bottom: 1px solid #334155;
    }

    .conv-header h3 {
      font-size: 14px;
    }

    .conv-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .message {
      display: flex;
      gap: 10px;
      margin-bottom: 16px;
    }

    .message-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
    }

    .message.claude .message-avatar { background: #431407; }
    .message.gemini .message-avatar { background: #1e3a5f; }

    .message-content {
      flex: 1;
      min-width: 0;
    }

    .message-meta {
      font-size: 11px;
      color: #64748b;
      margin-bottom: 4px;
    }

    .message-bubble {
      background: #334155;
      padding: 10px 12px;
      border-radius: 8px;
      font-size: 13px;
    }

    .message-type {
      display: inline-block;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 3px;
      margin-bottom: 6px;
    }

    .message-type.query { background: #3b82f6; color: white; }
    .message-type.response { background: #10b981; color: white; }
    .message-type.request { background: #f97316; color: white; }
    .message-type.handoff { background: #a855f7; color: white; }
    .message-type.feedback { background: #64748b; color: white; }

    .model-badge {
      display: inline-block;
      font-size: 9px;
      padding: 1px 5px;
      border-radius: 3px;
      background: #1e3a5f;
      color: #93c5fd;
      font-family: ui-monospace, monospace;
      margin-left: 6px;
    }

    .model-badge.target {
      background: #3f3f46;
      color: #a1a1aa;
    }

    .conv-input {
      padding: 16px;
      border-top: 1px solid #334155;
    }

    .input-row {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }

    .input-select {
      flex: 1;
      padding: 8px;
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 6px;
      color: #e2e8f0;
      font-size: 12px;
    }

    .input-textarea {
      width: 100%;
      padding: 10px;
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 6px;
      color: #e2e8f0;
      font-size: 13px;
      resize: none;
      height: 80px;
    }

    .input-textarea:focus, .input-select:focus {
      outline: none;
      border-color: #3b82f6;
    }

    .send-btn {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      background: #3b82f6;
      border: none;
      border-radius: 6px;
      color: white;
      font-size: 13px;
      cursor: pointer;
    }

    .send-btn:hover { background: #2563eb; }
    .send-btn:disabled { background: #475569; cursor: not-allowed; }

    /* Loading state */
    .loading {
      text-align: center;
      padding: 40px;
      color: #64748b;
    }

    .loading-spinner {
      width: 24px;
      height: 24px;
      border: 2px solid #334155;
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 12px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .empty-state {
      text-align: center;
      color: #64748b;
      padding: 40px 20px;
    }

    /* Polling indicator */
    .polling-indicator {
      font-size: 10px;
      color: #64748b;
      margin-left: 8px;
    }

    .polling-indicator.active {
      color: #10b981;
    }
  </style>
</head>
<body>
  <a href="index.html" class="back-link">‚Üê Back to Playgrounds</a>
  <div class="container">
    <aside class="sidebar">
      <h2>Tasks <span class="api-badge disconnected" id="api-badge">Offline</span></h2>

      <div class="task-list" id="task-list">
        <div class="loading">
          <div class="loading-spinner"></div>
          <div>Loading tasks...</div>
        </div>
      </div>

      <button class="new-task-btn" onclick="createTask()">+ New Task</button>
      <button class="refresh-btn" onclick="loadTasks()">‚Üª Refresh</button>

      <h3>Quick Actions</h3>
      <button class="refresh-btn" onclick="checkInbox('claude')">Check Claude Inbox</button>
      <button class="refresh-btn" onclick="checkInbox('gemini')" style="margin-top:4px">Check Gemini Inbox</button>
    </aside>

    <main class="main-area">
      <div class="flow-diagram">
        <div class="agent-box claude">
          <div class="agent-icon">üß°</div>
          <div class="agent-name">Claude</div>
          <div class="agent-status">opus-4.5 / sonnet-4</div>
          <div class="agent-models">CLI Agent ‚Ä¢ Headless</div>
        </div>

        <div class="flow-arrow">
          <div class="arrow-line top"></div>
          <div class="arrow-head right"></div>
          <div class="arrow-label top" id="top-arrow-label">query / request / handoff</div>

          <div class="arrow-line bottom"></div>
          <div class="arrow-head left"></div>
          <div class="arrow-label bottom" id="bottom-arrow-label">response / feedback</div>
        </div>

        <div class="agent-box gemini">
          <div class="agent-icon">üíô</div>
          <div class="agent-name">Gemini</div>
          <div class="agent-status">3-flash / 3-pro</div>
          <div class="agent-models">Naturalness ‚Ä¢ Research</div>
        </div>

        <div class="broker-box">
          <div class="broker-name">SQLite Message Broker</div>
          <div class="broker-path">.mcp/servers/message-broker/messages.db</div>
        </div>
      </div>

      <div class="prompt-area">
        <div class="prompt-header">
          <h4>Generated Code</h4>
          <button class="copy-btn" onclick="copyPrompt()">Copy</button>
        </div>
        <pre class="prompt-code" id="prompt-output"></pre>
      </div>
    </main>

    <aside class="conversation-panel">
      <div class="conv-header">
        <h3>Conversation Thread <span class="polling-indicator" id="polling-indicator"></span></h3>
      </div>

      <div class="conv-messages" id="messages">
        <div class="empty-state">Select a task to view messages</div>
      </div>

      <div class="conv-input">
        <div class="input-row">
          <select class="input-select" id="from-select" onchange="updateModelSelect()">
            <option value="claude">From: Claude</option>
            <option value="gemini">From: Gemini</option>
          </select>
          <select class="input-select" id="type-select">
            <option value="query">query</option>
            <option value="response">response</option>
            <option value="request">request</option>
            <option value="handoff">handoff</option>
            <option value="feedback">feedback</option>
          </select>
        </div>
        <div class="input-row">
          <select class="input-select" id="from-model-select">
            <option value="claude-opus-4-5-20251101">claude-opus-4.5</option>
            <option value="claude-sonnet-4-20250514">claude-sonnet-4</option>
            <option value="gemini-3-flash-preview">gemini-3-flash</option>
            <option value="gemini-3-pro-preview">gemini-3-pro</option>
          </select>
          <select class="input-select" id="to-model-select">
            <option value="">Target: Auto</option>
            <option value="claude-opus-4-5-20251101">claude-opus-4.5</option>
            <option value="claude-sonnet-4-20250514">claude-sonnet-4</option>
            <option value="gemini-3-flash-preview">gemini-3-flash</option>
            <option value="gemini-3-pro-preview">gemini-3-pro</option>
          </select>
        </div>
        <textarea class="input-textarea" id="message-input" placeholder="Type a message..."></textarea>
        <button class="send-btn" onclick="sendMessage()" id="send-btn" disabled>Send Message</button>
      </div>
    </aside>
  </div>

  <script>
    // ==================== CONFIG ====================

    const API_BASE = window.location.origin;
    const POLL_INTERVAL = 5000; // 5 seconds

    // ==================== STATE ====================

    const state = {
      tasks: [],
      selectedTask: null,
      messages: [],
      apiConnected: false,
      pollTimer: null,
      lastMessageId: 0
    };

    // ==================== API FUNCTIONS ====================

    async function fetchAPI(endpoint) {
      const response = await fetch(`${API_BASE}${endpoint}`);
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      return response.json();
    }

    async function initAPI() {
      const badge = document.getElementById('api-badge');

      try {
        // Test API connection
        await fetchAPI('/api/config');
        state.apiConnected = true;
        badge.className = 'api-badge connected';
        badge.textContent = 'Live';

        // Load tasks
        await loadTasks();

        // Start polling if a task is selected
        if (state.selectedTask) {
          startPolling();
        }

      } catch (error) {
        state.apiConnected = false;
        badge.className = 'api-badge disconnected';
        badge.textContent = 'Offline';

        document.getElementById('task-list').innerHTML = `
          <div class="empty-state">
            API not available.<br><br>
            Start the server:<br>
            <code style="font-size:11px">npm run playground:serve</code>
          </div>
        `;
      }
    }

    async function loadTasks() {
      if (!state.apiConnected) return;

      try {
        const tasks = await fetchAPI('/api/messages/tasks');
        state.tasks = tasks;
        renderTasks();
      } catch (error) {
        console.error('Failed to load tasks:', error);
      }
    }

    async function loadConversation(taskId) {
      if (!state.apiConnected || !taskId) return;

      try {
        const messages = await fetchAPI(`/api/messages/conversation/${taskId}`);
        state.messages = messages;

        // Track last message ID for polling
        if (messages.length > 0) {
          state.lastMessageId = messages[messages.length - 1].id;
        }

        renderMessages();
      } catch (error) {
        console.error('Failed to load conversation:', error);
      }
    }

    async function sendMessage() {
      const content = document.getElementById('message-input').value.trim();
      if (!content || !state.selectedTask) return;

      const from = document.getElementById('from-select').value;
      const type = document.getElementById('type-select').value;
      const fromModel = document.getElementById('from-model-select').value;
      const toModel = document.getElementById('to-model-select').value;
      const to = from === 'claude' ? 'gemini' : 'claude';

      // Build data with model info
      const data = JSON.stringify({
        from_model: fromModel,
        to_model: toModel || undefined
      });

      try {
        const response = await fetch(`${API_BASE}/api/messages/send`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            to,
            from_llm: from,
            content,
            message_type: type,
            task_id: state.selectedTask.task_id,
            data
          })
        });

        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        document.getElementById('message-input').value = '';

        // Reload conversation
        await loadConversation(state.selectedTask.task_id);

      } catch (error) {
        alert('Failed to send message: ' + error.message);
      }
    }

    function updateModelSelect() {
      const from = document.getElementById('from-select').value;
      const fromModelSelect = document.getElementById('from-model-select');

      // Set default model based on agent
      if (from === 'claude') {
        fromModelSelect.value = 'claude-opus-4-5-20251101';
      } else {
        fromModelSelect.value = 'gemini-3-flash-preview';
      }
    }

    async function checkInbox(agent) {
      if (!state.apiConnected) {
        alert(`In Claude Code, run:\n\nmcp__message-broker__check_inbox(for_llm="${agent}")`);
        return;
      }

      try {
        const messages = await fetchAPI(`/api/messages/inbox/${agent}?unread_only=true&limit=10`);
        if (messages.length === 0) {
          alert(`No unread messages for ${agent}`);
        } else {
          alert(`${messages.length} unread message(s) for ${agent}:\n\n` +
            messages.map(m => `[${m.id}] ${m.from_llm}: ${m.content.substring(0, 50)}...`).join('\n'));
        }
      } catch (error) {
        alert('Failed to check inbox: ' + error.message);
      }
    }

    function startPolling() {
      if (state.pollTimer) clearInterval(state.pollTimer);

      const indicator = document.getElementById('polling-indicator');
      indicator.textContent = '(polling)';
      indicator.className = 'polling-indicator active';

      state.pollTimer = setInterval(async () => {
        if (!state.selectedTask) return;

        try {
          const messages = await fetchAPI(`/api/messages/conversation/${state.selectedTask.task_id}`);

          // Check if there are new messages
          if (messages.length > state.messages.length) {
            state.messages = messages;
            state.lastMessageId = messages[messages.length - 1].id;
            renderMessages();

            // Flash indicator
            indicator.textContent = '(new!)';
            setTimeout(() => {
              indicator.textContent = '(polling)';
            }, 2000);
          }
        } catch (error) {
          console.error('Polling error:', error);
        }
      }, POLL_INTERVAL);
    }

    function stopPolling() {
      if (state.pollTimer) {
        clearInterval(state.pollTimer);
        state.pollTimer = null;
      }
      document.getElementById('polling-indicator').textContent = '';
    }

    // ==================== RENDERING ====================

    function renderTasks() {
      const container = document.getElementById('task-list');

      if (state.tasks.length === 0) {
        container.innerHTML = '<div class="empty-state">No tasks yet.<br>Create one to start chatting!</div>';
        return;
      }

      container.innerHTML = state.tasks.map(task => `
        <div class="task-item ${state.selectedTask?.task_id === task.task_id ? 'active' : ''}"
             onclick="selectTask('${task.task_id}')">
          <div class="task-id">${task.task_id}</div>
          <div class="task-name">${formatTaskName(task.task_id)}</div>
          <div class="task-meta">${task.message_count} messages</div>
        </div>
      `).join('');
    }

    function formatTaskName(taskId) {
      return taskId.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
    }

    function renderMessages() {
      const container = document.getElementById('messages');

      if (state.messages.length === 0) {
        container.innerHTML = '<div class="empty-state">No messages in this task yet</div>';
        updateFlowDiagram(0, 0);
        return;
      }

      const claudeToGemini = state.messages.filter(m => m.from_llm === 'claude').length;
      const geminiToClaude = state.messages.filter(m => m.from_llm === 'gemini').length;
      updateFlowDiagram(claudeToGemini, geminiToClaude);

      container.innerHTML = state.messages.map(msg => {
        // Parse model info from data field
        let fromModel = '';
        let toModel = '';
        if (msg.data) {
          try {
            const data = typeof msg.data === 'string' ? JSON.parse(msg.data) : msg.data;
            fromModel = data.from_model || '';
            toModel = data.to_model || '';
          } catch (e) {}
        }

        const modelInfo = fromModel ? `<span class="model-badge">${fromModel}</span>` : '';
        const toModelInfo = toModel ? ` ‚Üí <span class="model-badge target">${toModel}</span>` : '';

        return `
        <div class="message ${msg.from_llm}">
          <div class="message-avatar">${msg.from_llm === 'claude' ? 'üß°' : 'üíô'}</div>
          <div class="message-content">
            <div class="message-meta">
              ${msg.from_llm} ‚Üí ${msg.to_llm} ‚Ä¢ ${formatTime(msg.timestamp)}
              ${modelInfo}${toModelInfo}
            </div>
            <div class="message-bubble">
              <span class="message-type ${msg.message_type}">${msg.message_type}</span>
              <div>${escapeHtml(msg.content).replace(/\n/g, '<br>')}</div>
            </div>
          </div>
        </div>
      `}).join('');

      container.scrollTop = container.scrollHeight;
    }

    function renderPrompt() {
      const container = document.getElementById('prompt-output');

      if (!state.selectedTask) {
        container.innerHTML = '<span class="fn"># Select a task to see code examples</span>';
        return;
      }

      const taskId = state.selectedTask.task_id;
      const lastMsg = state.messages[state.messages.length - 1];
      const lastId = lastMsg ? lastMsg.id : '<msg_id>';

      container.innerHTML = `<span class="fn"># Send a message to Gemini (with model tracking)</span>
<span class="fn">mcp__message-broker__send_message</span>(
  <span class="key">to</span>=<span class="str">"gemini"</span>,
  <span class="key">from_llm</span>=<span class="str">"claude"</span>,
  <span class="key">from_model</span>=<span class="str">"claude-opus-4-5-20251101"</span>,
  <span class="key">to_model</span>=<span class="str">"gemini-3-flash-preview"</span>,
  <span class="key">content</span>=<span class="str">"Your message here"</span>,
  <span class="key">message_type</span>=<span class="str">"query"</span>,
  <span class="key">task_id</span>=<span class="str">"${taskId}"</span>
)

<span class="fn"># Bridge script: process specific message</span>
Bash('<span class="str">.venv/bin/python scripts/ai_agent_bridge.py process ${lastId}</span>')

<span class="fn"># Bridge script: ask gemini directly</span>
Bash('<span class="str">.venv/bin/python scripts/ai_agent_bridge.py ask-gemini "Your message" --task-id ${taskId}</span>')

<span class="fn"># Check for responses</span>
<span class="fn">mcp__message-broker__receive_messages</span>(
  <span class="key">for_llm</span>=<span class="str">"claude"</span>,
  <span class="key">task_id</span>=<span class="str">"${taskId}"</span>,
  <span class="key">unread_only</span>=<span class="str">True</span>
)`;
    }

    function updateFlowDiagram(c2g, g2c) {
      document.getElementById('top-arrow-label').textContent = `${c2g} messages ‚Üí`;
      document.getElementById('bottom-arrow-label').textContent = `‚Üê ${g2c} messages`;
    }

    function formatTime(timestamp) {
      const date = new Date(timestamp);
      return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    }

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // ==================== INTERACTIONS ====================

    function selectTask(taskId) {
      state.selectedTask = state.tasks.find(t => t.task_id === taskId) || { task_id: taskId };
      document.getElementById('send-btn').disabled = false;

      renderTasks();
      loadConversation(taskId);
      renderPrompt();
      startPolling();
    }

    function createTask() {
      const taskId = prompt('Enter task ID (e.g., "content-review-m15"):');
      if (!taskId) return;

      // Add to local state and select
      const newTask = { task_id: taskId, message_count: 0 };
      state.tasks.unshift(newTask);
      selectTask(taskId);
    }

    function copyPrompt() {
      const text = document.getElementById('prompt-output').textContent;
      navigator.clipboard.writeText(text).then(() => {
        const btn = document.querySelector('.copy-btn');
        btn.textContent = 'Copied!';
        btn.classList.add('copied');
        setTimeout(() => {
          btn.textContent = 'Copy';
          btn.classList.remove('copied');
        }, 2000);
      });
    }

    // ==================== INIT ====================

    initAPI();
  </script>
</body>
</html>
