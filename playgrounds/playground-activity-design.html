<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Activity Design Playground</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: #0f172a;
      color: #e2e8f0;
      min-height: 100vh;
    }

    .container {
      display: grid;
      grid-template-columns: 320px 1fr 380px;
      height: 100vh;
    }

    .back-link {
      position: absolute;
      top: 12px;
      left: 12px;
      color: #3b82f6;
      text-decoration: none;
      font-size: 12px;
      z-index: 100;
    }

    .back-link:hover { text-decoration: underline; }

    .sidebar {
      background: #1e293b;
      padding: 20px;
      padding-top: 40px;
      overflow-y: auto;
      border-right: 1px solid #334155;
    }

    .sidebar h2 {
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #94a3b8;
      margin-bottom: 16px;
    }

    .sidebar h3 {
      font-size: 12px;
      color: #64748b;
      margin: 20px 0 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .activity-types {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .activity-type-btn {
      padding: 10px 14px;
      font-size: 13px;
      background: #334155;
      border: 1px solid #475569;
      color: #e2e8f0;
      border-radius: 8px;
      cursor: pointer;
      text-align: left;
      transition: all 0.15s;
    }

    .activity-type-btn:hover { background: #475569; }
    .activity-type-btn.active { background: #3b82f6; border-color: #60a5fa; }

    .activity-type-btn .type-name {
      font-weight: 600;
      display: block;
    }

    .activity-type-btn .type-desc {
      font-size: 11px;
      color: #94a3b8;
      margin-top: 2px;
    }

    .activity-type-btn.active .type-desc { color: #bfdbfe; }

    .config-section {
      margin-top: 20px;
    }

    .config-row {
      margin-bottom: 16px;
    }

    .config-label {
      font-size: 12px;
      color: #94a3b8;
      margin-bottom: 6px;
      display: block;
    }

    .config-input {
      width: 100%;
      padding: 8px 12px;
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 6px;
      color: #e2e8f0;
      font-size: 13px;
    }

    .config-input:focus {
      outline: none;
      border-color: #3b82f6;
    }

    .config-slider {
      width: 100%;
      margin-top: 4px;
    }

    .slider-value {
      font-size: 12px;
      color: #3b82f6;
      float: right;
    }

    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 0;
    }

    .checkbox-row input[type="checkbox"] {
      width: 16px;
      height: 16px;
    }

    .preview-area {
      padding: 24px;
      overflow-y: auto;
      background: #0f172a;
    }

    .preview-card {
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 12px;
      padding: 24px;
      max-width: 700px;
      margin: 0 auto;
    }

    .preview-header {
      margin-bottom: 20px;
    }

    .preview-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .preview-instruction {
      font-size: 14px;
      color: #94a3b8;
    }

    /* Quiz styles */
    .quiz-question {
      margin-bottom: 24px;
    }

    .quiz-question-text {
      font-size: 15px;
      margin-bottom: 12px;
    }

    .quiz-options {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .quiz-option {
      padding: 12px 16px;
      background: #334155;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .quiz-option:hover { background: #475569; }

    .quiz-option.correct { background: #166534; }
    .quiz-option.incorrect { background: #991b1b; }

    .quiz-option-marker {
      width: 20px;
      height: 20px;
      border: 2px solid #64748b;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .quiz-option.correct .quiz-option-marker {
      background: #10b981;
      border-color: #10b981;
    }

    /* Match-up styles */
    .matchup-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .matchup-column h4 {
      font-size: 12px;
      color: #64748b;
      margin-bottom: 10px;
      text-transform: uppercase;
    }

    .matchup-item {
      padding: 12px 16px;
      background: #334155;
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .matchup-item:hover { background: #475569; }
    .matchup-item.selected { background: #3b82f6; }
    .matchup-item.matched { background: #166534; opacity: 0.7; }

    /* Fill-in styles */
    .fill-in-text {
      font-size: 16px;
      line-height: 2;
    }

    .fill-in-blank {
      display: inline-block;
      min-width: 100px;
      padding: 4px 12px;
      background: #334155;
      border-radius: 4px;
      border-bottom: 2px solid #3b82f6;
      margin: 0 4px;
    }

    .fill-in-blank.filled {
      background: #166534;
      border-color: #10b981;
    }

    .word-bank {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #334155;
    }

    .word-bank-item {
      padding: 8px 14px;
      background: #475569;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .word-bank-item:hover { background: #64748b; }
    .word-bank-item.used { opacity: 0.4; pointer-events: none; }

    /* Mark-the-words styles */
    .mark-text {
      font-size: 16px;
      line-height: 2;
    }

    .mark-word {
      display: inline;
      padding: 2px 6px;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .mark-word:hover { background: #334155; }
    .mark-word.marked { background: #3b82f6; }
    .mark-word.correct { background: #166534; }
    .mark-word.incorrect { background: #991b1b; }

    /* Ordering styles */
    .order-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .order-item {
      padding: 14px 18px;
      background: #334155;
      border-radius: 8px;
      cursor: grab;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .order-item:active { cursor: grabbing; }

    .order-number {
      width: 28px;
      height: 28px;
      background: #475569;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: 600;
    }

    /* YAML output panel */
    .yaml-panel {
      background: #1e293b;
      border-left: 1px solid #334155;
      display: flex;
      flex-direction: column;
    }

    .yaml-header {
      padding: 16px 20px;
      border-bottom: 1px solid #334155;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .yaml-header h3 {
      font-size: 12px;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .copy-btn {
      padding: 6px 14px;
      font-size: 12px;
      background: #3b82f6;
      border: none;
      color: white;
      border-radius: 6px;
      cursor: pointer;
    }

    .copy-btn:hover { background: #2563eb; }
    .copy-btn.copied { background: #10b981; }

    .yaml-content {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
    }

    .yaml-code {
      font-family: ui-monospace, 'SF Mono', monospace;
      font-size: 12px;
      line-height: 1.6;
      color: #e2e8f0;
      white-space: pre;
    }

    .yaml-key { color: #7dd3fc; }
    .yaml-string { color: #86efac; }
    .yaml-bool { color: #fbbf24; }
    .yaml-comment { color: #64748b; }

    /* Add items button */
    .add-item-btn {
      width: 100%;
      padding: 10px;
      background: transparent;
      border: 2px dashed #334155;
      border-radius: 8px;
      color: #64748b;
      cursor: pointer;
      margin-top: 12px;
      transition: all 0.15s;
    }

    .add-item-btn:hover {
      border-color: #3b82f6;
      color: #3b82f6;
    }

    /* Module selector styles */
    .module-selector {
      background: #0f172a;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
    }

    .module-selector select {
      width: 100%;
      padding: 8px 12px;
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 6px;
      color: #e2e8f0;
      font-size: 13px;
      margin-bottom: 8px;
    }

    .module-selector select:focus {
      outline: none;
      border-color: #3b82f6;
    }

    .module-actions {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    .module-btn {
      flex: 1;
      padding: 8px 12px;
      font-size: 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .module-btn.load {
      background: #334155;
      color: #e2e8f0;
    }

    .module-btn.load:hover { background: #475569; }

    .module-btn.save {
      background: #166534;
      color: #bbf7d0;
    }

    .module-btn.save:hover { background: #15803d; }

    .module-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .module-status {
      font-size: 11px;
      color: #64748b;
      margin-top: 8px;
      min-height: 16px;
    }

    .module-status.success { color: #10b981; }
    .module-status.error { color: #ef4444; }

    /* API status indicator */
    .api-indicator {
      font-size: 10px;
      padding: 4px 8px;
      border-radius: 4px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-left: 8px;
    }

    .api-indicator.connected { background: #166534; color: #bbf7d0; }
    .api-indicator.disconnected { background: #991b1b; color: #fecaca; }

    .api-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
    }
  </style>
</head>
<body>
  <a href="index.html" class="back-link">← Back to Playgrounds</a>
  <div class="container">
    <aside class="sidebar">
      <h2>Activity Design <span class="api-indicator disconnected" id="api-indicator"><span class="api-dot"></span><span id="api-text">API</span></span></h2>

      <div class="module-selector">
        <select id="level-select" onchange="onLevelChange()">
          <option value="">Select level...</option>
        </select>
        <select id="module-select" onchange="onModuleChange()" disabled>
          <option value="">Select module...</option>
        </select>
        <div class="module-actions">
          <button class="module-btn load" onclick="loadFromModule()" id="load-btn" disabled>Load Activities</button>
          <button class="module-btn save" onclick="saveToModule()" id="save-btn" disabled>Save to Module</button>
        </div>
        <select id="activity-select" style="width:100%;margin-top:8px;display:none;" onchange="onActivityChange()">
        </select>
        <div class="module-status" id="module-status"></div>
      </div>

      <h3>Activity Type</h3>
      <div class="activity-types" id="activity-types"></div>

      <div class="config-section" id="config-section"></div>
    </aside>

    <main class="preview-area">
      <div class="preview-card" id="preview"></div>
    </main>

    <aside class="yaml-panel">
      <div class="yaml-header">
        <h3>Generated YAML</h3>
        <button class="copy-btn" onclick="copyYaml()">Copy YAML</button>
      </div>
      <div class="yaml-content">
        <pre class="yaml-code" id="yaml-output"></pre>
      </div>
    </aside>
  </div>

  <script>
    // ==================== ACTIVITY TYPES ====================

    const ACTIVITY_TYPES = {
      quiz: {
        name: 'Quiz',
        desc: 'Multiple choice - single correct',
        defaults: {
          title: 'Vocabulary Quiz',
          instruction: 'Choose the correct answer.',
          items: [
            { question: 'Як перекладається "hello"?', options: [{text: 'привіт', correct: true}, {text: 'бувай', correct: false}, {text: 'дякую', correct: false}, {text: 'будь ласка', correct: false}] },
            { question: 'Що означає "дякую"?', options: [{text: 'hello', correct: false}, {text: 'goodbye', correct: false}, {text: 'thank you', correct: true}, {text: 'please', correct: false}] }
          ]
        }
      },
      select: {
        name: 'Select',
        desc: 'Multiple choice - multiple correct',
        defaults: {
          title: 'Grammar Select',
          instruction: 'Select all correct forms.',
          items: [
            { question: 'Які з цих слів є іменниками?', options: [
              { text: 'стіл', correct: true },
              { text: 'бігати', correct: false },
              { text: 'червоний', correct: false },
              { text: 'яблуко', correct: true }
            ], min_correct: 2 }
          ]
        }
      },
      'fill-in': {
        name: 'Fill in',
        desc: 'Gap fill with dropdown',
        defaults: {
          title: 'Complete the Sentences',
          instruction: 'Choose the correct words.',
          items: [
            { sentence: 'Я ___ українською мовою.', answer: 'говорю', options: ['говорю', 'говориш', 'говорять', 'говоримо'] },
            { sentence: 'Вона ___ каву щоранку.', answer: 'п\'є', options: ['п\'ю', 'п\'єш', 'п\'є', 'п\'ють'] }
          ]
        }
      },
      cloze: {
        name: 'Cloze',
        desc: 'Passage with multiple blanks',
        defaults: {
          title: 'Reading Cloze',
          instruction: 'Choose the correct words for the passage.',
          passage: 'Київ — {1} України. Це {2} місто на річці Дніпро.',
          blanks: [
            { id: 1, answer: 'столиця', options: ['столиця', 'село', 'гора'] },
            { id: 2, answer: 'велике', options: ['велике', 'маленьке', 'нове'] }
          ]
        }
      },
      'match-up': {
        name: 'Match Up',
        desc: 'Connect related items',
        defaults: {
          title: 'Match Ukrainian to English',
          instruction: 'Match each Ukrainian word with its English translation.',
          pairs: [
            { left: 'книга', right: 'book' },
            { left: 'стіл', right: 'table' },
            { left: 'вікно', right: 'window' }
          ]
        }
      },
      'group-sort': {
        name: 'Group Sort',
        desc: 'Sort items into categories',
        defaults: {
          title: 'Sort Nouns by Gender',
          instruction: 'Place each word in the correct gender group.',
          groups: [
            { name: 'Чоловічий', items: ['стіл', 'син', 'батько'] },
            { name: 'Жіночий', items: ['мама', 'книга', 'школа'] }
          ]
        }
      },
      unjumble: {
        name: 'Unjumble',
        desc: 'Reorder words into sentence',
        defaults: {
          title: 'Unjumble the Sentence',
          instruction: 'Drag the words into the correct order.',
          items: [
            { words: ['Я', 'люблю', 'читати'], answer: 'Я люблю читати' }
          ]
        }
      },
      'error-correction': {
        name: 'Error Correction',
        desc: 'Find and fix grammatical errors',
        defaults: {
          title: 'Fix the Mistakes',
          instruction: 'Find the incorrect word and choose the correction.',
          items: [
            { sentence: 'Я йду до школа.', error: 'школа', answer: 'школи', options: ['школи', 'школу', 'школою', 'школі'], explanation: 'Genitive case required after "до".' }
          ]
        }
      },
      'mark-the-words': {
        name: 'Mark the Words',
        desc: 'Identify words in text',
        defaults: {
          title: 'Find the Nouns',
          instruction: 'Click on all the nouns in the sentence.',
          text: 'Гарний день приніс радість у серце.',
          answers: ['день', 'радість', 'серце']
        }
      },
      translate: {
        name: 'Translate',
        desc: 'Translation multiple choice',
        defaults: {
          title: 'Translate to Ukrainian',
          instruction: 'Choose the correct Ukrainian translation.',
          items: [
            { source: 'I have a book.', options: [
              { text: 'У мене є книга.', correct: true },
              { text: 'Я маю книгу.', correct: true },
              { text: 'Мені є книга.', correct: false },
              { text: 'У мене була книга.', correct: false }
            ] }
          ]
        }
      },
      anagram: {
        name: 'Anagram',
        desc: 'Letter unscrambling',
        defaults: {
          title: 'Unscramble the Letters',
          instruction: 'Unscramble the letters to form a word.',
          items: [
            { scrambled: 'овлоко', answer: 'молоко', hint: 'milk' }
          ]
        }
      },
      'true-false': {
        name: 'True/False',
        desc: 'Judge statements',
        defaults: {
          title: 'True or False?',
          instruction: 'Decide if each statement is true or false.',
          items: [
            { statement: 'Київ — столиця України.', correct: true },
            { statement: 'В українській мові 32 літери.', correct: false }
          ]
        }
      },
      'essay-response': {
        name: 'Essay',
        desc: 'Long-form writing task',
        defaults: {
          title: 'Writing Task',
          instruction: 'Write a short essay on the given topic.',
          prompt: 'Опишіть свій улюблений день.',
          min_words: 50,
          model_answer: 'Мій улюблений день — це субота...',
          rubric: [
            { criteria: 'Grammar', description: 'Correct use of cases.' },
            { criteria: 'Vocabulary', description: 'Use of varied vocabulary.' }
          ]
        }
      }
    };

    // ==================== STATE ====================

    const API_BASE = window.location.origin;

    const state = {
      type: 'quiz',
      config: JSON.parse(JSON.stringify(ACTIVITY_TYPES.quiz.defaults)),
      apiConnected: false,
      levels: [],
      modules: [],
      selectedLevel: null,
      selectedModule: null,
      allActivities: [],  // Stores all activities from module (we edit one at a time)
      currentActivityIndex: 0  // Which activity in allActivities we're editing
    };

    // ==================== API FUNCTIONS ====================

    async function fetchAPI(endpoint) {
      const response = await fetch(`${API_BASE}${endpoint}`);
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      return response.json();
    }

    async function initAPI() {
      const indicator = document.getElementById('api-indicator');
      const text = document.getElementById('api-text');

      try {
        const config = await fetchAPI('/api/config');
        state.levels = config.levels;
        state.apiConnected = true;

        indicator.className = 'api-indicator connected';
        text.textContent = 'Live';

        // Populate level dropdown
        const levelSelect = document.getElementById('level-select');
        levelSelect.innerHTML = '<option value="">Select level...</option>' +
          state.levels.map(l => `<option value="${l.id}">${l.name}</option>`).join('');

      } catch (error) {
        state.apiConnected = false;
        indicator.className = 'api-indicator disconnected';
        text.textContent = 'Offline';
        console.log('API not available - running in standalone mode');
      }
    }

    async function onLevelChange() {
      const levelSelect = document.getElementById('level-select');
      const moduleSelect = document.getElementById('module-select');
      const loadBtn = document.getElementById('load-btn');
      const saveBtn = document.getElementById('save-btn');

      state.selectedLevel = levelSelect.value;
      state.selectedModule = null;

      if (!state.selectedLevel) {
        moduleSelect.disabled = true;
        moduleSelect.innerHTML = '<option value="">Select module...</option>';
        loadBtn.disabled = true;
        saveBtn.disabled = true;
        return;
      }

      setStatus('Loading modules...', '');

      try {
        const levelData = await fetchAPI(`/api/status/levels/${state.selectedLevel}`);
        state.modules = levelData.modules;

        moduleSelect.disabled = false;
        moduleSelect.innerHTML = '<option value="">Select module...</option>' +
          state.modules.map(m => `<option value="${m.id}">M${m.num}: ${m.title}</option>`).join('');

        setStatus('', '');
      } catch (error) {
        setStatus('Failed to load modules', 'error');
      }
    }

    function onModuleChange() {
      const moduleSelect = document.getElementById('module-select');
      const loadBtn = document.getElementById('load-btn');
      const saveBtn = document.getElementById('save-btn');

      state.selectedModule = moduleSelect.value;

      loadBtn.disabled = !state.selectedModule;
      saveBtn.disabled = !state.selectedModule;
    }

    async function loadFromModule() {
      if (!state.selectedLevel || !state.selectedModule) return;

      setStatus('Loading activities...', '');

      try {
        const data = await fetchAPI(`/api/activities/${state.selectedLevel}/${state.selectedModule}`);

        if (!data.activities || data.activities.length === 0) {
          setStatus('No activities found - creating new', '');
          state.allActivities = [];
          return;
        }

        state.allActivities = data.activities;
        state.currentActivityIndex = 0;

        // Show activity selector if multiple
        updateActivitySelector();

        // Load first activity into editor
        if (state.allActivities.length > 0) {
          loadActivityIntoEditor(state.allActivities[0]);
        }

        setStatus(`Loaded ${data.activities.length} activities`, 'success');
      } catch (error) {
        setStatus('Failed to load: ' + error.message, 'error');
      }
    }

    function loadActivityIntoEditor(activity) {
      const type = activity.type;
      if (!ACTIVITY_TYPES[type]) {
        console.warn('Unknown activity type:', type);
        return;
      }

      state.type = type;

      // Convert API format to editor format
      const config = {
        title: activity.title || '',
        instruction: activity.instruction || ''
      };

      if (type === 'quiz' || type === 'select' || type === 'translate') {
        config.items = (activity.items || activity.questions || activity.source || []).map(item => ({
          question: item.question,
          source: item.source,
          options: (item.options || []).map(opt => (
            typeof opt === 'string'
              ? { text: opt, correct: opt === item.correct }
              : { text: opt.text, correct: opt.correct }
          )),
          min_correct: item.min_correct
        }));
      } else if (type === 'fill-in') {
        config.items = (activity.items || activity.sentences || []).map(s => ({
          sentence: s.sentence || s.text,
          answer: s.answer,
          options: s.options || [s.answer]
        }));
      } else if (type === 'cloze') {
        config.passage = activity.passage;
        config.blanks = activity.blanks || [];
      } else if (type === 'match-up') {
        config.pairs = activity.pairs || [];
      } else if (type === 'group-sort') {
        config.groups = activity.groups || [];
      } else if (type === 'unjumble') {
        config.items = (activity.items || []).map(item => ({
          words: item.words,
          answer: item.answer
        }));
      } else if (type === 'error-correction') {
        config.items = activity.items || [];
      } else if (type === 'mark-the-words') {
        config.text = activity.text || '';
        config.answers = activity.answers || [];
      } else if (type === 'anagram') {
        config.items = activity.items || [];
      } else if (type === 'true-false') {
        config.items = (activity.items || activity.statements || []).map(s => ({
          statement: s.statement,
          correct: s.correct ?? s.answer
        }));
      } else if (type === 'essay-response') {
        config.prompt = activity.prompt;
        config.min_words = activity.min_words || 100;
        config.model_answer = activity.model_answer;
        config.rubric = activity.rubric || [];
      }

      state.config = config;
      updateAll();
    }

    async function saveToModule() {
      if (!state.selectedLevel || !state.selectedModule) return;

      setStatus('Saving...', '');

      try {
        // Convert editor format to YAML format
        const activity = convertToYamlFormat();

        // Non-destructive save: append to existing activities
        // Replace first activity if loaded, or append as new
        let activities;
        if (state.allActivities.length > 0) {
          // Replace the activity at current index (default: first)
          activities = [...state.allActivities];
          activities[state.currentActivityIndex || 0] = activity;
        } else {
          // No existing activities - start fresh
          activities = [activity];
        }

        const response = await fetch(`${API_BASE}/api/activities/${state.selectedLevel}/${state.selectedModule}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ activities })
        });

        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        // Update local state to reflect saved activities
        state.allActivities = activities;

        const result = await response.json();
        setStatus(`Saved ${activities.length} activities to ${result.saved}`, 'success');
      } catch (error) {
        setStatus('Failed to save: ' + error.message, 'error');
      }
    }

    function convertToYamlFormat() {
      const c = state.config;
      const type = state.type;
      const activity = {
        type: type,
        title: c.title,
        instruction: c.instruction
      };

      if (type === 'quiz' || type === 'select' || type === 'translate') {
        activity.items = c.items.map(item => {
          const formatted = { options: item.options };
          if (item.question) formatted.question = item.question;
          if (item.source) formatted.source = item.source;
          if (item.min_correct) formatted.min_correct = item.min_correct;
          return formatted;
        });
      } else if (type === 'fill-in') {
        activity.items = c.items.map(item => ({
          sentence: item.sentence,
          answer: item.answer,
          options: item.options
        }));
      } else if (type === 'cloze') {
        activity.passage = c.passage;
        activity.blanks = c.blanks;
      } else if (type === 'match-up') {
        activity.pairs = c.pairs;
      } else if (type === 'group-sort') {
        activity.groups = c.groups;
      } else if (type === 'unjumble') {
        activity.items = c.items.map(item => ({
          words: item.words,
          answer: item.answer
        }));
      } else if (type === 'error-correction') {
        activity.items = c.items;
      } else if (type === 'mark-the-words') {
        activity.text = c.text;
        activity.answers = c.answers;
      } else if (type === 'anagram') {
        activity.items = c.items;
      } else if (type === 'true-false') {
        activity.items = c.items.map(item => ({
          statement: item.statement,
          correct: item.correct
        }));
      } else if (type === 'essay-response') {
        activity.prompt = c.prompt;
        activity.min_words = c.min_words;
        activity.model_answer = c.model_answer;
        activity.rubric = c.rubric;
      }

      return activity;
    }

    function setStatus(message, type) {
      const status = document.getElementById('module-status');
      status.textContent = message;
      status.className = 'module-status' + (type ? ' ' + type : '');
    }

    function updateActivitySelector() {
      const select = document.getElementById('activity-select');
      if (state.allActivities.length <= 1) {
        select.style.display = 'none';
        return;
      }

      select.style.display = 'block';
      select.innerHTML = state.allActivities.map((a, i) =>
        `<option value="${i}" ${i === state.currentActivityIndex ? 'selected' : ''}>
          Activity ${i + 1}: ${a.type} - ${a.title || 'Untitled'}
        </option>`
      ).join('') + `<option value="new">+ Add New Activity</option>`;
    }

    function onActivityChange() {
      const select = document.getElementById('activity-select');
      const value = select.value;

      if (value === 'new') {
        // Add new activity
        state.currentActivityIndex = state.allActivities.length;
        state.allActivities.push(convertToYamlFormat());
        updateActivitySelector();
        // Reset to default quiz for new activity
        selectType('quiz');
        setStatus('New activity added - edit and save', '');
      } else {
        state.currentActivityIndex = parseInt(value);
        loadActivityIntoEditor(state.allActivities[state.currentActivityIndex]);
        setStatus(`Editing activity ${state.currentActivityIndex + 1}`, '');
      }
    }

    // ==================== RENDERING ====================

    function renderActivityTypes() {
      const container = document.getElementById('activity-types');
      container.innerHTML = Object.entries(ACTIVITY_TYPES).map(([id, type]) => `
        <button class="activity-type-btn ${state.type === id ? 'active' : ''}" onclick="selectType('${id}')">
          <span class="type-name">${type.name}</span>
          <span class="type-desc">${type.desc}</span>
        </button>
      `).join('');
    }

    function renderConfig() {
      const container = document.getElementById('config-section');
      const type = state.type;
      const c = state.config;

      let html = `
        <h3>General</h3>
        <div class="config-row">
          <label class="config-label">Title</label>
          <input class="config-input" type="text" value="${c.title || ''}" onchange="updateConfig('title', this.value)">
        </div>
        <div class="config-row">
          <label class="config-label">Instruction</label>
          <input class="config-input" type="text" value="${c.instruction || ''}" onchange="updateConfig('instruction', this.value)">
        </div>
      `;

      if (type === 'quiz' || type === 'select' || type === 'translate') {
        html += `<h3>Items (${c.items.length})</h3>`;
        c.items.forEach((item, i) => {
          html += `
            <div class="config-row" style="background: #334155; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
              <label class="config-label">${type === 'translate' ? 'Source Text' : 'Question'}</label>
              <input class="config-input" type="text" value="${item.question || item.source || ''}"
                     onchange="updateItem(${i}, '${type === 'translate' ? 'source' : 'question'}', this.value)" style="margin-bottom: 8px;">

              <label class="config-label">Options</label>
              ${item.options.map((opt, j) => `
                <div style="display: flex; gap: 8px; margin-bottom: 4px;">
                  <input type="${type === 'select' ? 'checkbox' : 'radio'}" name="correct-${i}"
                         ${opt.correct ? 'checked' : ''}
                         onchange="updateOptionCorrect(${i}, ${j}, ${type === 'select' ? 'this.checked' : 'true'})">
                  <input class="config-input" type="text" value="${opt.text}"
                         onchange="updateOptionText(${i}, ${j}, this.value)" style="flex: 1;">
                  <button onclick="removeOption(${i}, ${j})" style="background:none;border:none;color:#ef4444;cursor:pointer;">×</button>
                </div>
              `).join('')}
              <button class="module-btn load" style="width:100%;margin-top:4px;" onclick="addOption(${i})">+ Add Option</button>
            </div>
          `;
        });
        html += `<button class="add-item-btn" onclick="addItem()">+ Add Item</button>`;
      } else if (type === 'fill-in') {
        html += `<h3>Sentences (${c.items.length})</h3>`;
        c.items.forEach((item, i) => {
          html += `
            <div class="config-row" style="background: #334155; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
              <label class="config-label">Sentence (use ___ for blank)</label>
              <input class="config-input" type="text" value="${item.sentence}" onchange="updateItem(${i}, 'sentence', this.value)" style="margin-bottom: 8px;">
              <label class="config-label">Correct Answer</label>
              <input class="config-input" type="text" value="${item.answer}" onchange="updateItem(${i}, 'answer', this.value)" style="margin-bottom: 8px;">
              <label class="config-label">Distractors (comma separated)</label>
              <input class="config-input" type="text" value="${item.options.filter(o => o !== item.answer).join(', ')}"
                     onchange="updateFillInOptions(${i}, this.value)">
            </div>
          `;
        });
        html += `<button class="add-item-btn" onclick="addItem()">+ Add Sentence</button>`;
      } else if (type === 'cloze') {
        html += `
          <div class="config-row">
            <label class="config-label">Passage (use {1}, {2} etc. for blanks)</label>
            <textarea class="config-input" rows="4" onchange="updateConfig('passage', this.value)">${c.passage}</textarea>
          </div>
          <h3>Blanks (${c.blanks.length})</h3>
          ${c.blanks.map((blank, i) => `
            <div class="config-row" style="background: #334155; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
              <label class="config-label">Blank #${blank.id} Correct Answer</label>
              <input class="config-input" type="text" value="${blank.answer}" onchange="updateClozeBlank(${i}, 'answer', this.value)" style="margin-bottom: 8px;">
              <label class="config-label">All Options (comma separated)</label>
              <input class="config-input" type="text" value="${blank.options.join(', ')}" onchange="updateClozeBlank(${i}, 'options', this.value.split(',').map(s=>s.trim()))">
            </div>
          `).join('')}
          <button class="add-item-btn" onclick="addClozeBlank()">+ Add Blank</button>
        `;
      } else if (type === 'match-up') {
        html += `<h3>Pairs (${c.pairs.length})</h3>`;
        c.pairs.forEach((pair, i) => {
          html += `
            <div class="config-row" style="display: flex; gap: 8px; margin-bottom: 8px;">
              <input class="config-input" type="text" value="${pair.left}" onchange="updateMatchPair(${i}, 'left', this.value)">
              <span style="color: #64748b;">↔</span>
              <input class="config-input" type="text" value="${pair.right}" onchange="updateMatchPair(${i}, 'right', this.value)">
              <button onclick="removeMatchPair(${i})" style="background:none;border:none;color:#ef4444;cursor:pointer;">×</button>
            </div>
          `;
        });
        html += `<button class="add-item-btn" onclick="addMatchPair()">+ Add Pair</button>`;
      } else if (type === 'group-sort') {
        html += `<h3>Groups (${c.groups.length})</h3>`;
        c.groups.forEach((group, i) => {
          html += `
            <div class="config-row" style="background: #334155; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
              <label class="config-label">Group Name</label>
              <input class="config-input" type="text" value="${group.name}" onchange="updateGroup(${i}, 'name', this.value)" style="margin-bottom: 8px;">
              <label class="config-label">Items (one per line)</label>
              <textarea class="config-input" rows="3" onchange="updateGroup(${i}, 'items', this.value.split('\\n').filter(s=>s.trim()))">${group.items.join('\n')}</textarea>
            </div>
          `;
        });
        html += `<button class="add-item-btn" onclick="addGroup()">+ Add Group</button>`;
      } else if (type === 'unjumble') {
        html += `<h3>Sentences (${c.items.length})</h3>`;
        c.items.forEach((item, i) => {
          html += `
            <div class="config-row" style="background: #334155; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
              <label class="config-label">Correct Sentence</label>
              <input class="config-input" type="text" value="${item.answer}" onchange="updateUnjumble(${i}, this.value)">
            </div>
          `;
        });
        html += `<button class="add-item-btn" onclick="addItem()">+ Add Sentence</button>`;
      } else if (type === 'error-correction') {
        html += `<h3>Items (${c.items.length})</h3>`;
        c.items.forEach((item, i) => {
          html += `
            <div class="config-row" style="background: #334155; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
              <label class="config-label">Sentence</label>
              <input class="config-input" type="text" value="${item.sentence}" onchange="updateItem(${i}, 'sentence', this.value)" style="margin-bottom: 8px;">
              <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-bottom:8px;">
                <div>
                  <label class="config-label">Incorrect Part</label>
                  <input class="config-input" type="text" value="${item.error}" onchange="updateItem(${i}, 'error', this.value)">
                </div>
                <div>
                  <label class="config-label">Correction</label>
                  <input class="config-input" type="text" value="${item.answer}" onchange="updateItem(${i}, 'answer', this.value)">
                </div>
              </div>
              <label class="config-label">Options (comma separated)</label>
              <input class="config-input" type="text" value="${item.options.join(', ')}" onchange="updateItem(${i}, 'options', this.value.split(',').map(s=>s.trim()))" style="margin-bottom: 8px;">
              <label class="config-label">Explanation</label>
              <input class="config-input" type="text" value="${item.explanation}" onchange="updateItem(${i}, 'explanation', this.value)">
            </div>
          `;
        });
        html += `<button class="add-item-btn" onclick="addItem()">+ Add Item</button>`;
      } else if (type === 'mark-the-words') {
        html += `
          <div class="config-row">
            <label class="config-label">Text</label>
            <textarea class="config-input" rows="4" onchange="updateConfig('text', this.value)">${c.text}</textarea>
          </div>
          <div class="config-row">
            <label class="config-label">Correct words (comma-separated)</label>
            <input class="config-input" type="text" value="${c.answers.join(', ')}" onchange="updateConfig('answers', this.value.split(',').map(s => s.trim()))">
          </div>
        `;
      } else if (type === 'anagram') {
        html += `<h3>Items (${c.items.length})</h3>`;
        c.items.forEach((item, i) => {
          html += `
            <div class="config-row" style="background: #334155; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
              <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
                <div>
                  <label class="config-label">Scrambled</label>
                  <input class="config-input" type="text" value="${item.scrambled}" onchange="updateItem(${i}, 'scrambled', this.value)">
                </div>
                <div>
                  <label class="config-label">Answer</label>
                  <input class="config-input" type="text" value="${item.answer}" onchange="updateItem(${i}, 'answer', this.value)">
                </div>
              </div>
              <label class="config-label" style="margin-top:8px;">Hint (optional)</label>
              <input class="config-input" type="text" value="${item.hint || ''}" onchange="updateItem(${i}, 'hint', this.value)">
            </div>
          `;
        });
        html += `<button class="add-item-btn" onclick="addItem()">+ Add Item</button>`;
      } else if (type === 'true-false') {
        html += `<h3>Statements (${c.items.length})</h3>`;
        c.items.forEach((item, i) => {
          html += `
            <div class="config-row" style="background: #334155; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
              <input class="config-input" type="text" value="${item.statement}" onchange="updateItem(${i}, 'statement', this.value)" style="margin-bottom: 8px;">
              <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                <input type="checkbox" ${item.correct ? 'checked' : ''} onchange="updateItem(${i}, 'correct', this.checked)">
                Correct answer is TRUE
              </label>
            </div>
          `;
        });
        html += `<button class="add-item-btn" onclick="addItem()">+ Add Statement</button>`;
      } else if (type === 'essay-response') {
        html += `
          <div class="config-row">
            <label class="config-label">Prompt</label>
            <textarea class="config-input" rows="3" onchange="updateConfig('prompt', this.value)">${c.prompt}</textarea>
          </div>
          <div class="config-row">
            <label class="config-label">Minimum Words</label>
            <input class="config-input" type="number" value="${c.min_words}" onchange="updateConfig('min_words', parseInt(this.value))">
          </div>
          <div class="config-row">
            <label class="config-label">Model Answer</label>
            <textarea class="config-input" rows="4" onchange="updateConfig('model_answer', this.value)">${c.model_answer}</textarea>
          </div>
          <h3>Rubric</h3>
          ${c.rubric.map((r, i) => `
            <div class="config-row" style="background: #334155; padding: 12px; border-radius: 8px; margin-bottom: 8px;">
              <input class="config-input" type="text" value="${r.criteria}" placeholder="Criteria" onchange="updateRubric(${i}, 'criteria', this.value)" style="margin-bottom: 4px;">
              <input class="config-input" type="text" value="${r.description}" placeholder="Description" onchange="updateRubric(${i}, 'description', this.value)">
            </div>
          `).join('')}
          <button class="add-item-btn" onclick="addRubric()">+ Add Rubric Item</button>
        `;
      }

      container.innerHTML = html;
    }

    function renderPreview() {
      const container = document.getElementById('preview');
      const c = state.config;
      const type = state.type;

      let html = `
        <div class="preview-header">
          <div class="preview-title">${c.title || 'Activity Title'}</div>
          <div class="preview-instruction">${c.instruction || 'Instructions here'}</div>
        </div>
      `;

      if (type === 'quiz' || type === 'select' || type === 'translate') {
        html += (c.items || []).map((item, i) => `
          <div class="quiz-question">
            <div class="quiz-question-text">${i + 1}. ${item.question || item.source}</div>
            <div class="quiz-options">
              ${(item.options || []).map(opt => `
                <div class="quiz-option ${opt.correct ? 'correct' : ''}">
                  <div class="quiz-option-marker"></div>
                  <span>${opt.text}</span>
                </div>
              `).join('')}
            </div>
          </div>
        `).join('');
      } else if (type === 'fill-in') {
        html += '<div class="fill-in-text">';
        (c.items || []).forEach(item => {
          const parts = (item.sentence || '').split('___');
          html += parts[0] + `<span class="fill-in-blank">${item.answer}</span>` + (parts[1] || '');
          html += '<br>';
        });
        html += '</div>';
      } else if (type === 'cloze') {
        let passage = c.passage || '';
        (c.blanks || []).forEach(blank => {
          passage = passage.replace(`{${blank.id}}`, `<span class="fill-in-blank">${blank.answer}</span>`);
        });
        html += `<div class="fill-in-text">${passage.replace(/\n/g, '<br>')}</div>`;
      } else if (type === 'match-up') {
        html += `
          <div class="matchup-container">
            <div class="matchup-column">
              <h4>Left</h4>
              ${(c.pairs || []).map(p => `<div class="matchup-item">${p.left}</div>`).join('')}
            </div>
            <div class="matchup-column">
              <h4>Right</h4>
              ${(c.pairs || []).map(p => `<div class="matchup-item">${p.right}</div>`).join('')}
            </div>
          </div>
        `;
      } else if (type === 'group-sort') {
        html += `<div style="display:grid; grid-template-columns: repeat(${c.groups.length}, 1fr); gap:16px;">`;
        (c.groups || []).forEach(group => {
          html += `
            <div class="matchup-column">
              <h4>${group.name}</h4>
              <div style="background:#0f172a; padding:10px; border-radius:8px; min-height:100px;">
                ${(group.items || []).map(item => `<div class="matchup-item" style="margin-bottom:4px;">${item}</div>`).join('')}
              </div>
            </div>
          `;
        });
        html += `</div>`;
      } else if (type === 'unjumble') {
        html += (c.items || []).map((item, i) => `
          <div style="margin-bottom:20px;">
            <div class="quiz-question-text">${i + 1}. Unjumble:</div>
            <div style="display:flex; flex-wrap:wrap; gap:8px;">
              ${(item.words || []).map(word => `<span class="word-bank-item">${word}</span>`).join('')}
            </div>
          </div>
        `).join('');
      } else if (type === 'error-correction') {
        html += (c.items || []).map((item, i) => `
          <div style="margin-bottom:20px;">
            <div class="fill-in-text">${item.sentence.replace(item.error, `<span class="mark-word incorrect">${item.error}</span>`)}</div>
            <div style="margin-top:8px; color:#10b981; font-size:14px;">Correction: ${item.answer}</div>
          </div>
        `).join('');
      } else if (type === 'mark-the-words') {
        const words = (c.text || '').split(/(\s+)/);
        html += '<div class="mark-text">';
        words.forEach(word => {
          const cleanWord = word.replace(/[.,!?;:]/g, '');
          if ((c.answers || []).includes(cleanWord)) {
            html += `<span class="mark-word correct">${word}</span>`;
          } else if (word.trim()) {
            html += `<span class="mark-word">${word}</span>`;
          } else {
            html += word;
          }
        });
        html += '</div>';
      } else if (type === 'anagram') {
        html += (c.items || []).map((item, i) => `
          <div style="margin-bottom:20px;">
            <div class="quiz-question-text">${i + 1}. ${item.scrambled} ${item.hint ? `<small style="color:#64748b;">(${item.hint})</small>` : ''}</div>
            <div style="color:#10b981; font-size:14px;">Answer: ${item.answer}</div>
          </div>
        `).join('');
      } else if (type === 'true-false') {
        html += (c.items || []).map((item, i) => `
          <div class="quiz-question">
            <div class="quiz-question-text">${i + 1}. ${item.statement}</div>
            <div class="quiz-options">
              <div class="quiz-option ${item.correct ? 'correct' : ''}">
                <div class="quiz-option-marker"></div>
                <span>True</span>
              </div>
              <div class="quiz-option ${!item.correct ? 'correct' : ''}">
                <div class="quiz-option-marker"></div>
                <span>False</span>
              </div>
            </div>
          </div>
        `).join('');
      } else if (type === 'essay-response') {
        html += `
          <div class="fill-in-text" style="margin-bottom:16px;">${c.prompt}</div>
          <div style="background:#334155; padding:16px; border-radius:8px;">
            <h4 style="font-size:12px; color:#94a3b8; margin-bottom:8px;">MODEL ANSWER</h4>
            <div style="font-size:14px; line-height:1.6;">${c.model_answer}</div>
          </div>
        `;
      }

      container.innerHTML = html;
    }

    function renderYaml() {
      const container = document.getElementById('yaml-output');
      const activity = convertToYamlFormat();

      // Simple YAML generator for preview
      function formatYaml(obj, indent = 0) {
        const space = '  '.repeat(indent);
        if (Array.isArray(obj)) {
          return obj.map(item => `${space}- ${formatYaml(item, indent + 1).trimStart()}`).join('\n');
        } else if (typeof obj === 'object' && obj !== null) {
          return Object.entries(obj)
            .filter(([_, v]) => v !== undefined && v !== null)
            .map(([k, v]) => {
              if (typeof v === 'object') {
                return `${space}<span class="yaml-key">${k}:</span>\n${formatYaml(v, indent + 1)}`;
              }
              const valClass = typeof v === 'boolean' ? 'yaml-bool' : 'yaml-string';
              return `${space}<span class="yaml-key">${k}:</span> <span class="${valClass}">${v}</span>`;
            }).join('\n');
        }
        return `${space}${obj}`;
      }

      container.innerHTML = formatYaml([activity]);
    }

    function updateAll() {
      renderActivityTypes();
      renderConfig();
      renderPreview();
      renderYaml();
    }

    // ==================== INTERACTIONS ====================

    function selectType(type) {
      state.type = type;
      state.config = JSON.parse(JSON.stringify(ACTIVITY_TYPES[type].defaults));
      updateAll();
    }

    function updateConfig(key, value) {
      state.config[key] = value;
      updateAll();
    }

    function updateItem(index, key, value) {
      state.config.items[index][key] = value;
      updateAll();
    }

    function addItem() {
      const type = state.type;
      let newItem = {};

      if (type === 'quiz' || type === 'select' || type === 'translate') {
        newItem = {
          question: type === 'translate' ? undefined : 'New Question?',
          source: type === 'translate' ? 'New Source Text' : undefined,
          options: [
            { text: 'Option A', correct: true },
            { text: 'Option B', correct: false },
            { text: 'Option C', correct: false },
            { text: 'Option D', correct: false }
          ]
        };
      } else if (type === 'fill-in') {
        newItem = { sentence: 'Я ___ (іти).', answer: 'йду', options: ['йду', 'йдеш', 'йде', 'йдуть'] };
      } else if (type === 'unjumble') {
        newItem = { words: ['Я', 'йду'], answer: 'Я йду' };
      } else if (type === 'error-correction') {
        newItem = { sentence: 'Я йду до школа.', error: 'школа', answer: 'школи', options: ['школи', 'школу', 'школою'], explanation: '' };
      } else if (type === 'anagram') {
        newItem = { scrambled: 'овлоко', answer: 'молоко', hint: '' };
      } else if (type === 'true-false') {
        newItem = { statement: 'New statement.', correct: true };
      }

      state.config.items.push(newItem);
      updateAll();
    }

    function updateOptionText(itemIndex, optIndex, text) {
      state.config.items[itemIndex].options[optIndex].text = text;
      updateAll();
    }

    function updateOptionCorrect(itemIndex, optIndex, correct) {
      if (state.type !== 'select') {
        // Reset all others to false for radio-like behavior
        state.config.items[itemIndex].options.forEach((opt, i) => {
          opt.correct = (i === optIndex);
        });
      } else {
        state.config.items[itemIndex].options[optIndex].correct = correct;
      }
      updateAll();
    }

    function addOption(itemIndex) {
      state.config.items[itemIndex].options.push({ text: 'New Option', correct: false });
      updateAll();
    }

    function removeOption(itemIndex, optIndex) {
      state.config.items[itemIndex].options.splice(optIndex, 1);
      updateAll();
    }

    function updateFillInOptions(index, value) {
      const distractors = value.split(',').map(s => s.trim()).filter(Boolean);
      const answer = state.config.items[index].answer;
      state.config.items[index].options = [answer, ...distractors];
      updateAll();
    }

    function updateClozeBlank(index, key, value) {
      state.config.blanks[index][key] = value;
      updateAll();
    }

    function addClozeBlank() {
      const nextId = state.config.blanks.length + 1;
      state.config.blanks.push({ id: nextId, answer: 'word', options: ['word', 'other', 'another'] });
      updateAll();
    }

    function updateMatchPair(index, key, value) {
      state.config.pairs[index][key] = value;
      updateAll();
    }

    function addMatchPair() {
      state.config.pairs.push({ left: 'слово', right: 'word' });
      updateAll();
    }

    function removeMatchPair(index) {
      state.config.pairs.splice(index, 1);
      updateAll();
    }

    function updateGroup(index, key, value) {
      state.config.groups[index][key] = value;
      updateAll();
    }

    function addGroup() {
      state.config.groups.push({ name: 'New Group', items: [] });
      updateAll();
    }

    function updateUnjumble(index, value) {
      state.config.items[index].answer = value;
      state.config.items[index].words = value.split(' ').sort(() => Math.random() - 0.5);
      updateAll();
    }

    function updateRubric(index, key, value) {
      state.config.rubric[index][key] = value;
      updateAll();
    }

    function addRubric() {
      state.config.rubric.push({ criteria: 'New Criteria', description: '' });
      updateAll();
    }

    function copyYaml() {
      const activity = convertToYamlFormat();

      function formatYamlPlain(obj, indent = 0) {
        const space = '  '.repeat(indent);
        if (Array.isArray(obj)) {
          return obj.map(item => `${space}- ${formatYamlPlain(item, indent + 1).trimStart()}`).join('\n');
        } else if (typeof obj === 'object' && obj !== null) {
          return Object.entries(obj)
            .filter(([_, v]) => v !== undefined && v !== null)
            .map(([k, v]) => {
              if (typeof v === 'object') {
                return `${space}${k}:\n${formatYamlPlain(v, indent + 1)}`;
              }
              return `${space}${k}: ${v}`;
            }).join('\n');
        }
        return `${space}${obj}`;
      }

      const yaml = formatYamlPlain([activity]);

      navigator.clipboard.writeText(yaml).then(() => {
        const btn = document.querySelector('.copy-btn');
        btn.textContent = 'Copied!';
        btn.classList.add('copied');
        setTimeout(() => {
          btn.textContent = 'Copy YAML';
          btn.classList.remove('copied');
        }, 2000);
      });
    }

    // ==================== INIT ====================

    updateAll();
    initAPI();
  </script>
</body>
</html>
