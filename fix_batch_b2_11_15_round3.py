
import yaml
import re
import os
import glob

# Essays
essay_activities = {
    "11": {
        "type": "essay-response",
        "title": "Мій ідеальний день",
        "prompt": "Напишіть есе (150-200 слів) про ваш ідеальний день. Використовуйте складносурядні та складнопідрядні речення з різними видами підрядності (означальними, з'ясувальними, обставинними).",
        "min_words": 150,
        "model_answer": "Мій ідеальний день починається тоді, коли сонце тільки сходить. Я прокидаюся, бо відчуваю приплив енергії. Сніданок, який я готую сам, завжди смачний і корисний. Я люблю читати книгу, поки п'ю каву. Потім я йду на прогулянку в парк, де співають птахи і цвітуть квіти. Хоча у мене багато справ, я завжди знаходжу час для відпочинку. Ввечері я зустрічаюся з друзями, щоб обговорити новини. Ми говоримо про все, що нас цікавить. Коли день закінчується, я відчуваю щастя, тому що встиг зробити все заплановане."
    },
    "12": {
        "type": "essay-response",
        "title": "Моя думка про соцмережі",
        "prompt": "Напишіть есе (150-200 слів) про роль соціальних мереж у сучасному житті. Використовуйте вставні слова різних груп: впевненість (безумовно), невпевненість (мабуть), джерело повідомлення (на мою думку), порядок викладу думок (по-перше, отже).",
        "min_words": 150,
        "model_answer": "На мою думку, соціальні мережі відіграють подвійну роль у нашому житті. По-перше, вони, безумовно, допомагають нам залишатися на зв'язку з друзями. Звичайно, це дуже зручно. По-друге, це джерело інформації. Як відомо, новини поширюються там миттєво. Проте, на жаль, є і негативні сторони. Здається, люди стали менше спілкуватися в реальному житті. Крім того, напевно, соцмережі забирають занадто багато часу. Отже, ми повинні використовувати їх розумно. Врешті-решт, реальне життя важливіше за віртуальне."
    },
    "13": {
        "type": "essay-response",
        "title": "Емоційна історія",
        "prompt": "Напишіть коротку емоційну історію (150-200 слів) про несподівану подію. Використовуйте емфатичні конструкції та інверсію для підсилення емоцій (Саме цей день я запам'ятав..., Ніколи не бачив я...).",
        "min_words": 150,
        "model_answer": "Саме цей день змінив моє життя назавжди. Ніколи раніше не бачив я такої краси. Посеред похмурого, сірого міста раптом розквітли тисячі квітів. Дивовижним було це видовище! Люди, зазвичай такі заклопотані, зупинялися і посміхалися. Щастя світилося в їхніх очах. Саме тоді зрозумів я, як мало потрібно для радості. Не гроші, а краса врятує світ. Довго ще згадував я цей день. Тільки краса здатна творити дива."
    },
    "14": {
        "type": "essay-response",
        "title": "Переваги читання",
        "prompt": "Напишіть есе-роздум (150-200 слів) про користь читання книг. Використовуйте різноманітні стилістичні сполучники (не тільки... а й, як... так і, або... або, проте, однак) для зв'язку думок.",
        "min_words": 150,
        "model_answer": "Читання книг є не тільки розвагою, а й важливим інструментом розвитку. Як художня література, так і наукові праці збагачують наш внутрішній світ. Ми дізнаємося про нове, проте не забуваємо про старе. Книги вчать нас мислити, однак вони також розвивають уяву. Або ви читаєте регулярно, або ваш мозок втрачає гнучкість. З одного боку, це вимагає часу, з іншого боку, результат того вартий. Тому читайте, адже знання — це сила."
    },
    "15": {
        "type": "essay-response",
        "title": "Мовні стилі",
        "prompt": "Напишіть текст (150-200 слів), у якому ви порівнюєте два стилі мовлення (наприклад, науковий і розмовний). Опишіть ситуацію, де кожен з них є доречним. Використовуйте лексику, характерну для опису стилів.",
        "min_words": 150,
        "model_answer": "Українська мова багата на стилі. Науковий стиль, наприклад, використовується в підручниках і статтях. Він характеризується точністю, логічністю та використанням термінів. Мета наукового стилю — передати інформацію. Натомість розмовний стиль ми чуємо щодня вдома і на вулиці. Він емоційний, невимушений, часто містить діалектизми або сленг. Якщо на конференції доречно говорити термінами, то в розмові з другом це виглядатиме дивно. Кожен стиль має своє місце і час. Володіння різними стилями — ознака високої культури мовлення."
    }
}

# Unjumble Replacements (All modules 11-15)
# Keys are stripped of punctuation for matching
unjumble_map = {
    # M11
    "Я знаю що він прийде": "Я точно знаю, що він обов'язково прийде сьогодні ввечері.",
    "Книга яку я читаю цікава": "Ця нова історична книга, яку я зараз читаю, надзвичайно цікава.",
    "Коли він прийшов ми почали": "Тільки коли він нарешті прийшов, ми відразу почали нашу важливу нараду.",
    "Він не прийшов бо захворів": "На жаль, він сьогодні не прийшов на роботу, бо несподівано захворів.",
    "Він працював щоб заробити": "Він тяжко працював кожного дня, щоб заробити гроші на навчання.",
    "Хоча йшов дощ ми гуляли": "Хоча на вулиці йшов сильний дощ, ми все одно довго гуляли в парку.",
    "Він сказав що книга цікава": "Він вчора сказав мені, що ця нова книга дуже цікава і повчальна.",
    "Сонце зайшло і стало темно": "Яскраве сонце швидко зайшло за обрій, і надворі одразу стало темно.",
    "Він хотів допомогти але не зміг": "Він щиро хотів нам допомогти з переїздом, але, на жаль, не зміг.",
    "Якщо ти хочеш залишайся": "Якщо ти дійсно цього хочеш, то, будь ласка, залишайся з нами ще трохи.",
    "Місто де я народився красиве": "Старовинне місто, де я народився і виріс, неймовірно красиве і затишне.",
    "Я думаю що він знає правду": "Я чомусь думаю, що він насправді знає всю приховану правду.",
    "Або ти йдеш або залишаєшся": "Або ти зараз йдеш разом з нами, або ти назавжди залишаєшся тут.",
    "Він говорив наче знав усе": "Він так впевнено говорив про це, наче він справді знав абсолютно усе.",
    "Я запізнився тому що був затор": "Я сьогодні сильно запізнився на роботу, тому що в центрі був великий затор.",
    "Після того як він пішов стало тихо": "Відразу після того як він пішов з кімнати, у домі стало дуже тихо.",
    
    # M12
    "Можливо він прийде завтра": "Цілком можливо, що він прийде до нас у гості вже завтра вранці.",
    "На жаль ми пропустили зустріч": "На великий жаль, ми через затори пропустили цю важливу ділову зустріч.",
    "Безумовно це правильне рішення": "Безумовно, це було єдине правильне та виважене рішення в цій ситуації.",
    "До речі я бачив вас учора": "До речі, я випадково бачив вас учора ввечері біля театру.",
    "По-перше потрібно проаналізувати дані": "По-перше, нам потрібно дуже уважно проаналізувати всі отримані статистичні дані.",
    "Отже ми можемо підсумувати результати": "Отже, тепер ми нарешті можемо підсумувати остаточні результати нашої роботи.",
    "Мабуть він уже пішов": "Мабуть, він уже давно пішов додому, бо світло в кабінеті не горить.",
    "На щастя ніхто не постраждав": "На велике щастя, під час цієї аварії ніхто з пасажирів не постраждав.",
    "Як відомо українська мова є слов'янською": "Як усім добре відомо, українська мова є однією з наймелодійніших слов'янських мов.",
    "Нарешті я хочу подякувати всім": "Нарешті, я хочу щиро подякувати всім присутнім за вашу підтримку.",
    "Іншими словами проєкт закрито": "Іншими словами, цей амбітний проєкт, на жаль, було офіційно закрито.",
    "Здається він помилився з адресою": "Здається, він трохи помилився з адресою і прийшов не в той будинок.",
    "На думку вчених клімат змінюється": "На думку провідних вчених, клімат на планеті стрімко і незворотно змінюється.",
    "На диво всі погодились": "На велике диво, всі учасники зборів одразу погодились з моєю пропозицією.",
    "Звичайно ви маєте рацію": "Звичайно, ви абсолютно маєте рацію в цьому непростому питанні.",
    "У будь-якому разі ми продовжуємо працювати": "У будь-якому разі, незважаючи на труднощі, ми продовжуємо наполегливо працювати.",

    # M13
    "Цю книгу я вже прочитав": "Цю чудову історичну книгу я вже повністю прочитав минулого літа.",
    "Настала рання весна": "Нарешті після довгої зими настала довгоочікувана тепла рання весна.",
    "Учора ввечері ми зустрілися": "Тільки учора пізно ввечері ми нарешті зустрілися після довгої розлуки.",
    "Голосно він це сказав": "Дуже голосно і впевнено він це сказав перед усіма присутніми.",
    "Небаченим був успіх": "Справді небаченим і грандіозним був успіх нашої національної збірної.",
    "Саме цей момент став вирішальним": "Саме цей напружений момент став вирішальним у всій цій грі.",
    "Цей фільм бачили усі": "Цей відомий класичний фільм, мабуть, бачили вже абсолютно усі.",
    "Тричі вона перечитувала роман": "Вже тричі вона уважно перечитувала цей захопливий роман про кохання.",
    "Першою прийшла вона": "На нашу ранкову зустріч першою прийшла саме вона, а не він.",
    "Важливою стала ця подія": "Надзвичайно важливою стала ця подія для історії нашого міста.",
    "Ніколи раніше він не бачив такого": "Ніколи раніше він не бачив такого дивовижного природного явища.",
    "Увечері пішов дощ": "Пізно увечері раптово пішов сильний проливний дощ з грозою.",
    "Чудовою була його робота": "Справді чудовою і професійною була його робота над цим проєктом.",
    "У цьому місті народився Шевченко": "Саме у цьому славному місті народився великий український поет Шевченко.",
    "Саме це питання важливе": "Саме це складне питання зараз є найбільш важливим для нас.",
    "Успішно студенти здали іспит": "Дуже успішно всі студенти нашої групи здали цей складний іспит.",

    # M14
    "Він не тільки читав а й писав": "Він не тільки багато читав книги, а й сам писав цікаві оповідання.",
    "Вона як співає так і танцює": "Вона як чудово співає на сцені, так і професійно танцює.",
    "Або ми встигнемо або запізнимося": "Або ми зараз встигнемо на автобус, або безнадійно запізнимося на зустріч.",
    "Чи то дощ чи то сніг": "На вулиці йде чи то холодний дощ, чи то мокрий сніг.",
    "То сонце світить то хмари": "То яскраве сонце світить, то темні хмари закривають усе небо.",
    "Не так важко як здається": "Це завдання не так важко виконати, як це може здатися на перший погляд.",
    "Чим більше читаєш тим більше знаєш": "Чим більше ти читаєш корисних книг, тим більше ти знаєш про світ.",
    "Якби я знав я б прийшов": "Якби я заздалегідь знав про це, я б обов'язково прийшов.",
    "Хоч він і втомився але працював": "Хоч він і дуже втомився за день, але продовжував працювати.",
    "Незважаючи на дощ ми пішли": "Незважаючи на сильний проливний дощ, ми все одно пішли на прогулянку.",
    "Для того щоб виграти треба тренуватися": "Для того щоб виграти у змаганнях, треба багато і наполегливо тренуватися.",
    "Тому що він захворів він не прийшов": "Тому що він раптово захворів на грип, він не прийшов сьогодні.",
    "Через те що було пізно ми пішли": "Через те що було вже дуже пізно, ми вирішили піти додому.",
    "Унаслідок того що сталась аварія дорога закрита": "Унаслідок того що на мосту сталась аварія, дорога повністю закрита.",
    "Завдяки тому що ми вчилися ми склали іспит": "Завдяки тому що ми старанно вчилися, ми успішно склали іспит.",
    "У той час як одні працювали інші відпочивали": "У той час як одні старанно працювали, інші просто відпочивали в тіні.",

    # M15
    "Це офіційний документ": "Цей папір — це важливий офіційний документ з печаткою.",
    "Ми проводимо експеримент": "Ми сьогодні проводимо складний науковий експеримент у лабораторії.",
    "Сонце сідало за гори": "Червоне сонце повільно сідало за високі сині гори.",
    "Привіт як справи": "Привіт, друже, як твої справи сьогодні?",
    "Згідно з законом це заборонено": "Згідно з чинним законом України, це суворо заборонено.",
    "Методологія дослідження базується на аналізі": "Методологія нашого дослідження базується на детальному аналізі даних.",
    "Вітер вив як голодний звір": "Холодний вітер вив за вікном, як страшний голодний звір.",
    "Слухай давай підемо в кіно": "Слухай, а давай ми сьогодні ввечері підемо разом в кіно.",
    "Наказ набуває чинності з моменту підписання": "Цей наказ набуває законної чинності з моменту його підписання директором.",
    "Результати підтверджують гіпотезу": "Отримані нами результати повністю підтверджують висунуту наукову гіпотезу.",
    "Очі її сяяли як зорі": "Очі її радісно сяяли в темряві, як яскраві вечірні зорі.",
    "Та ну його цей ремонт": "Та ну його, цей нескінченний ремонт, я вже так втомився.",
    "Шановний пане Директоре": "Шановний пане Директоре, дозвольте звернутися до Вас із проханням.",
    "Атом складається з ядра та електронів": "Атом будь-якого елемента складається з позитивного ядра та електронів.",
    "Ліс шумів наче розмовляв": "Старий ліс таємниче шумів, наче тихо розмовляв із подорожнім.",
    "Ти бачив що вони утнули": "Ти бачив, що вони вчора ввечері там утнули?"
}

# Regex replacements for short quiz prompts
quiz_patterns = [
    (r"Яке речення (.*)\?", r"Визначте, яке з наведених речень \1?"),
    (r"Скільки (.*)\?", r"Порахуйте і вкажіть, скільки саме \1?"),
    (r"Який сполучник (.*)\?", r"Виберіть зі списку: який сполучник \1?"),
    (r"Коли (.*)\?", r"У якому випадку або за якої умови \1?"),
    (r"Який знак (.*)\?", r"Який розділовий знак слід поставити в реченні, якщо \1?"),
    (r"Який тип (.*)\?", r"Визначте, який граматичний тип \1?"),
    (r"До якої категорії (.*)\?", r"До якої семантичної категорії належить слово або вираз \1?"),
    (r"Яке вставне слово (.*)\?", r"Яке з наведених вставних слів найкраще \1?"),
    (r"Який вираз (.*)\?", r"Який зі сталих виразів або словосполучень \1?"),
    (r"Яке слово (.*)\?", r"Яке з поданих слів або словосполучень \1?"),
    (r"Яке речення звучить (.*)\?", r"Проаналізуйте варіанти: яке речення звучить найбільш \1?"),
    (r"Яке речення підходить (.*)\?", r"Яке з наведених речень найкраще стилістично підходить \1?"),
    (r"Яке речення є (.*)\?", r"Серед запропонованих варіантів оберіть речення, яке є \1?"),
    (r"Яке речення не є (.*)\?", r"Знайдіть речення, яке за своєю структурою НЕ є \1?"),
    (r"Яке дієслово (.*)\?", r"Яке з перелічених дієслів граматично \1?"),
    (r"Яке речення демонструє (.*)\?", r"Яке з наведених нижче речень найяскравіше демонструє \1?"),
    (r"Яке речення містить (.*)\?", r"У якому з поданих речень наявна конструкція, що містить \1?"),
    (r"Яке речення має (.*)\?", r"Яке з речень побудовано граматично правильно і має \1?"),
    (r"Яка характеристика (.*)\?", r"Яка з наведених характеристик є визначальною для \1?"),
    (r"Що таке (.*)\?", r"Дайте визначення: що саме в лінгвістиці означає термін \1?"),
    (r"Де (.*)\?", r"У якому місці речення або тексту зазвичай \1?"),
    (r"Чому (.*)\?", r"Поясніть причину: чому в українській мові \1?"),
    (r"Як (.*)\?", r"Яким чином або за допомогою яких засобів \1?")
]

def process_file(filepath, module_num):
    print(f"Processing {filepath}...")
    with open(filepath, 'r') as f:
        activities = yaml.safe_load(f)
    
    modified = False
    
    # 1. Expand Unjumble
    for act in activities:
        if act.get('type') == 'unjumble':
            for item in act.get('items', []):
                ans = item.get('answer', '')
                # Normalize key by stripping punctuation and spaces
                norm_ans = ans.replace('.', '').replace(',', '').replace('?', '').replace('!', '').strip()
                if norm_ans in unjumble_map:
                    item['answer'] = unjumble_map[norm_ans]
                    item['words'] = [w.strip(".,!?;") for w in unjumble_map[norm_ans].split() if w.strip(".,!?;")]
                    modified = True
                else:
                    # Try matching with punctuation too
                    if ans in unjumble_map:
                        item['answer'] = unjumble_map[ans]
                        item['words'] = [w.strip(".,!?;") for w in unjumble_map[ans].split() if w.strip(".,!?;")]
                        modified = True

    # 2. Expand Quiz (Robust)
    for act in activities:
        if act.get('type') in ['quiz', 'select']:
            for item in act.get('items', []):
                q = item.get('question', '')
                if len(q.split()) < 10:
                    for pattern, repl in quiz_patterns:
                        if re.match(pattern, q):
                            item['question'] = re.sub(pattern, repl, q)
                            modified = True
                            break
                    # Fallback expansion if no regex match but still short
                    if len(item['question'].split()) < 10 and "?" in q:
                         if not q.startswith("Визначте") and not q.startswith("Укажіть"):
                            new_q = "Будь ласка, визначте: " + q[0].lower() + q[1:]
                            if len(new_q.split()) >= 10:
                                item['question'] = new_q
                                modified = True

    # 3. Add Essay
    if not any(a.get('type') == 'essay-response' for a in activities):
        if str(module_num) in essay_activities:
            activities.append(essay_activities[str(module_num)])
            print("  Added essay.")
            modified = True

    if modified:
        with open(filepath, 'w') as f:
            yaml.dump(activities, f, allow_unicode=True, sort_keys=False)
        print("  Updated activities.")

# Iterate 11-15
for i in range(11, 16):
    path = f"curriculum/l2-uk-en/b2/activities/{i}-*.yaml"
    files = glob.glob(path)
    for f in files:
        process_file(f, i)
    
    # Fix Markdown header
    md_files = glob.glob(f"curriculum/l2-uk-en/b2/{i}-*.md")
    for f in md_files:
        with open(f, 'r') as file:
            content = file.read()
        if "## Тест: Прочитайте текст" in content:
            content = content.replace("## Тест: Прочитайте текст", "## Вступ")
            with open(f, 'w') as file:
                file.write(content)
            print(f"  Updated markdown header for {f}")
