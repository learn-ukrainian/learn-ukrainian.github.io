import yaml
import re
import os

# Robust Replacements Map (Keyword -> Full Prompt)
replacements = {
    # M11
    "послідовне підпорядкування": "Визначте, яке з наведених речень містить складну конструкцію з послідовним підпорядкуванням підрядних частин?",
    "однорідного підпорядкування": "Яке з наведених нижче речень є класичним прикладом однорідного підпорядкування підрядних частин?",
    "протиставним": "Виберіть зі списку сполучник, який є протиставним і вживається для протиставлення частин речення?",
    "неоднорідне": "У якому з наведених речень використано неоднорідне (паралельне) підпорядкування підрядних частин?",
    "вкладене підрядне": "Знайдіть серед варіантів речення, яке містить вкладене підрядне речення всередині головного або іншого підрядного?",
    "питання «чому?»": "Який граматичний тип підрядного речення зазвичай відповідає на логічне питання «чому?» або «з якої причини?»",
    "безсполучниковим": "Яке з наведених складних речень є безсполучниковим, тобто частини якого поєднані лише інтонацією?",
    "вводить цільове": "Який підрядний сполучник найчастіше вводить підрядне речення мети (цільове підрядне)?",
    "спільний другорядний": "Яке складносурядне речення містить спільний другорядний член, що скасовує необхідність коми перед «і»?",
    "не є сполучником": "Виберіть слово, яке НЕ є сполучником підрядності, а належить до сурядних сполучників або інших частин мови?",
    "правильно розставлені коми": "У якому з наведених складних речень правильно розставлені всі розділові знаки (коми)?",
    "відрізняє безсполучникове": "Що саме принципово відрізняє безсполучникове складне речення від складносурядних та складнопідрядних речень?",
    "допустовому підрядному": "Яке логічне питання зазвичай ставиться до підрядного допустового речення в складному реченні?",
    "три підрядних": "У якому з наведених складних речень є щонайменше три підрядні частини, з'єднані сполучниками?",
    "граматично неправильне": "Визначте, яке з наведених складних речень побудовано граматично або пунктуаційно неправильно?",
    
    # M12
    "негативне ставлення": "Яке з наведених вставних слів або виразів найкраще виражає негативне ставлення мовця до повідомлюваного?",
    "перефразування": "Який вставний вираз зазвичай використовується для перефразування або уточнення попередньої думки?",
    "не є вставним": "Яке з наведених слів граматично НЕ є вставним, а виконує функцію члена речення?",
    "здивування": "Яке вставне слово або вираз найкраще передає емоцію здивування від несподіваного факту?",
    "завершує перелік": "Який вставний вираз зазвичай використовується для того, щоб логічно завершити перелік аргументів?",
    "джерело інформації": "Який з наведених виразів вказує на джерело інформації (кому належить думка)?",
    "логічний порядок": "Яке вставне слово допомагає структурувати текст і вказує на логічний порядок викладу?",
    "суб'єктивне враження": "Яке слово найкраще передає суб'єктивне враження або невпевненість мовця у факті?",
    "найвищий ступінь впевненості": "Яке з наведених вставних слів виражає найвищий, абсолютний ступінь впевненості?",
    "додаткової інформації": "Який вставний вираз використовується для введення додаткової, побічної інформації в речення?",
    "синтаксична особливість": "Яка основна синтаксична особливість відрізняє вставні слова від інших членів речення?",
    "пунктуювати вставне": "Яким чином або за допомогою яких розділових знаків правильно виділяти вставне слово в середині речення?",
    "найвищу ймовірність": "Яке з поданих слів або словосполучень виражає найвищу ступінь ймовірності (майже впевненість)?",
    "офіційним синонімом": "Яке з поданих слів або словосполучень є офіційним синонімом до розмовного слова?",
    
    # M13
    "емфатичним": "Яке з наведених речень характеризується емфатичним порядком слів для виділення головної думки?",
    "інверсію": "У якому з наведених речень використано стилістичну інверсію для підсилення емоційного впливу?",
    "початку речення": "Який член речення винесено на початок для логічного наголосу в цьому прикладі?",
    "підсилювальна частка": "Яка роль підсилювальної частки у формуванні змісту цього емфатичного речення?",
    "прямий порядок": "Яке з наведених речень має прямий, нейтральний порядок слів (підмет - присудок)?",
    "невмотивованою": "У якому випадку або за якої умови інверсія в реченні вважається стилістично невмотивованою?",
    
    # M14
    "протиставлення": "Який сполучник найкраще підходить для вираження різкого протиставлення двох думок або фактів?",
    "наслідок": "Який сполучник або сполучне слово вказує на логічний наслідок попередньої дії?",
    "умову": "Який сполучник вводить підрядне речення, що виражає реальну або нереальну умову?",
    "допуст": "Який сполучник використовується для введення допустового підрядного речення (незважаючи на що)?",
    "градацію": "Який парний сполучник використовується для вираження градації (не тільки..., а й...)?",
    "початку речення": "Які сполучники стилістично доречно вживати на самому початку складного речення?",
    
    # M15
    "офіційно-діловий": "Яка з наведених ознак є найбільш характерною та визначальною для офіційно-ділового стилю?",
    "науковий стиль": "Які лексичні та граматичні засоби є типовими для сучасного наукового стилю української мови?",
    "публіцистичний": "Яка основна мета та функція публіцистичного стилю в системі функціональних стилів?",
    "розмовний": "Які риси є визначальними для розмовного стилю в ситуації невимушеного спілкування?",
    "художній": "Які мовні засоби найчастіше використовуються в художньому стилі для створення образності?",
    "книжного": "Яке з наведених слів або виразів має відтінок книжного, піднесеного стилю?"
}

def process_file(filepath):
    print(f"Processing {filepath}...")
    with open(filepath, 'r') as f:
        activities = yaml.safe_load(f)
    
    modified = False
    for act in activities:
        if act.get('type') in ['quiz', 'select']:
            for item in act.get('items', []):
                q = item.get('question')
                # Check keywords (case-insensitive)
                for key, replacement in replacements.items():
                    if key.lower() in q.lower() and len(q.split()) < 10:
                        print(f"  Replacing Q: '{q}' -> '{replacement}'")
                        item['question'] = replacement
                        modified = True
                        break
    
    if modified:
        with open(filepath, 'w') as f:
            yaml.dump(activities, f, allow_unicode=True, sort_keys=False)
        print("  Updated.")
    else:
        print("  No changes needed.")

# Iterate 11-15
import glob
for i in range(11, 16):
    path = f"curriculum/l2-uk-en/b2/activities/{i}-*.yaml"
    files = glob.glob(path)
    for f in files:
        process_file(f)